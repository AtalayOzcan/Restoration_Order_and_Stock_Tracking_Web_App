@model Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.MenuItem
@{
    ViewData["Title"] = "Ürün Düzenle";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = ViewData["Categories"] as List<Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Category>
                  ?? new List<Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Category>();
}

@section Styles {
<style>
.form-page { max-width:580px; margin:0 auto; }
.page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1.75rem; flex-wrap:wrap; gap:.75rem; }
.page-title  { font-family:'Syne',sans-serif; font-size:1.6rem; font-weight:700; margin:0; }

.card { background:var(--card-bg,rgba(255,255,255,.04)); border:1px solid var(--border,rgba(255,255,255,.08)); border-radius:16px; padding:2rem; }
[data-theme="light"] .card { background:#fff; border-color:#e5e7eb; box-shadow:0 1px 8px rgba(0,0,0,.06); }

.form-group { margin-bottom:1.1rem; }
.form-label { display:block; font-size:.8rem; font-weight:600; opacity:.65; margin-bottom:.4rem; letter-spacing:.04em; text-transform:uppercase; }
.form-control { width:100%; padding:.65rem .9rem; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:10px; color:inherit; font-size:.9rem; font-family:'DM Sans',sans-serif; transition:border-color .15s,box-shadow .15s; box-sizing:border-box; }
[data-theme="light"] .form-control { background:#f9fafb; border-color:#d1d5db; color:#111827; }
.form-control:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.2); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }

.toggle-group { display:flex; align-items:center; gap:.75rem; margin-top:.2rem; }
.toggle-switch { position:relative; display:inline-block; width:44px; height:24px; flex-shrink:0; }
.toggle-switch input { opacity:0; width:0; height:0; }
.toggle-slider { position:absolute; inset:0; background:rgba(255,255,255,.12); border-radius:999px; cursor:pointer; transition:background .2s; }
[data-theme="light"] .toggle-slider { background:#d1d5db; }
.toggle-slider:before { content:''; position:absolute; width:18px; height:18px; left:3px; top:3px; background:#fff; border-radius:50%; transition:transform .2s; box-shadow:0 1px 3px rgba(0,0,0,.3); }
.toggle-switch input:checked + .toggle-slider { background:#6366f1; }
.toggle-switch input:checked + .toggle-slider:before { transform:translateX(20px); }

.btn { display:inline-flex; align-items:center; gap:.4rem; padding:.55rem 1.1rem; border-radius:10px; font-size:.85rem; font-weight:600; cursor:pointer; border:none; transition:all .18s; text-decoration:none; }
.btn-primary { background:#6366f1; color:#fff; }
.btn-primary:hover { background:#4f46e5; }
.btn-ghost { background:transparent; color:inherit; border:1px solid var(--border,rgba(255,255,255,.12)); }
.btn-ghost:hover { background:rgba(255,255,255,.06); }

.alert { padding:.85rem 1rem; border-radius:10px; margin-bottom:1rem; font-size:.88rem; }
.alert-error { background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.25); color:#ef4444; }
</style>
}

<div class="form-page">
    <div class="page-header">
        <h1 class="page-title">✏️ Ürün Düzenle</h1>
        <a asp-action="Index" class="btn btn-ghost">← Geri</a>
    </div>

    <div class="card">
        <form id="editForm">
            @Html.AntiForgeryToken()
            <input type="hidden" id="menuItemId" value="@Model.MenuItemId" />
            <div id="alertBox" class="alert alert-error" style="display:none;"></div>

            <div class="form-group">
                <label class="form-label">Ürün Adı *</label>
                <input type="text" id="menuItemName" class="form-control" value="@Model.MenuItemName" maxlength="200" required />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Kategori *</label>
                    <select id="categoryId" class="form-control" required>
                        @foreach (var cat in categories)
                        {
                            // Şartı dışarıda bir değişkene bağlayarak hatayı engelliyoruz
                            bool selected = (cat.CategoryId == Model?.CategoryId);

                            <option value="@cat.CategoryId" selected="@selected">
                                @cat.CategoryName
                            </option>
                        }
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Fiyat (₺) *</label>
                    <input type="number" id="menuItemPrice" class="form-control" value="@Model.MenuItemPrice" min="0" step="0.01" required />
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Açıklama</label>
                <textarea id="description" class="form-control" rows="2">@Model.Description</textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Stok Miktarı</label>
                    <input type="number" id="stockQuantity" class="form-control" value="@Model.StockQuantity" min="0" />
                </div>
                <div class="form-group" style="display:flex;flex-direction:column;justify-content:flex-end;">
                    <label class="form-label">Stok Takibi</label>
                    <div class="toggle-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="trackStock" @(Model.TrackStock ? "checked" : "") />
                            <span class="toggle-slider"></span>
                        </label>
                        <span>Takip Et</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Satışa Açık</label>
                <div class="toggle-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="isAvailable" @(Model.IsAvailable ? "checked" : "") />
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Mevcut</span>
                </div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:.6rem; margin-top:1.5rem;">
                <a asp-action="Index" class="btn btn-ghost">İptal</a>
                <button type="submit" class="btn btn-primary">💾 Güncelle</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
<script>
document.getElementById('editForm').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = e.submitter; btn.disabled = true;

    const body = new URLSearchParams({
        id:            document.getElementById('menuItemId').value,
        menuItemName:  document.getElementById('menuItemName').value,
        categoryId:    document.getElementById('categoryId').value,
        menuItemPrice: document.getElementById('menuItemPrice').value,
        description:   document.getElementById('description').value,
        stockQuantity: document.getElementById('stockQuantity').value,
        trackStock:    document.getElementById('trackStock').checked,
        isAvailable:   document.getElementById('isAvailable').checked,
        __RequestVerificationToken: document.querySelector('input[name="__RequestVerificationToken"]').value
    });

    const res  = await fetch('/Menu/Edit', { method:'POST', body });
    const data = await res.json();
    btn.disabled = false;

    if (data.success) {
        window.location.href = '/Menu';
    } else {
        const box = document.getElementById('alertBox');
        box.textContent = data.message;
        box.style.display = 'block';
    }
});
</script>
}
