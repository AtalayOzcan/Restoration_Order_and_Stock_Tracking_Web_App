@{
    ViewData["Title"] = ViewData["Title"]?.ToString() ?? "Adisyon Aç";
    var table = (Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Table)ViewBag.Table;
    var categories = (List<Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Category>)ViewBag.Categories;
    var allItems = categories.SelectMany(c => c.MenuItems).ToList();
}

@section Styles {
    <style>
        /* ─── POS sayfası layout'u dışa taşıyor (content padding'i ezer) ─── */
        .content { padding: 0 !important; }

        * { box-sizing: border-box; }

        /* ─── Ana 2 sütun ─────────────────────────────────────────────────── */
        .pos-wrap {
            display: grid;
            grid-template-columns: 1fr 340px;
            height: calc(100vh - 56px);   /* topbar yüksekliği */
            overflow: hidden;
        }

        /* ══════════════════════════════════════════════════════════════════
           SOL PANEL — Menü
        ══════════════════════════════════════════════════════════════════ */
        .pos-menu {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--surface);
        }

        /* ── Üst bar ─── */
        .pos-header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--surface2);
        }

        .pos-table-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 14px;
            background: var(--accent);
            color: #fff;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 800;
            font-family: 'Syne', sans-serif;
            letter-spacing: .02em;
            flex-shrink: 0;
        }

        .pos-search-wrap {
            flex: 1;
            position: relative;
        }

        .pos-search-wrap input {
            width: 100%;
            padding: 9px 12px 9px 36px;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            outline: none;
            transition: border-color .15s;
        }
        .pos-search-wrap input:focus { border-color: var(--accent); }
        .pos-search-wrap input::placeholder { color: var(--text-muted); }

        .pos-search-icon {
            position: absolute;
            left: 11px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: .4;
            pointer-events: none;
        }

        .pos-back {
            flex-shrink: 0;
            padding: 8px 14px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-decoration: none;
            transition: all .15s;
            white-space: nowrap;
        }
        .pos-back:hover { color: var(--text); border-color: var(--text-muted); }

        /* ── Kategori Tab Şeridi ─── */
        .cat-strip {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            scrollbar-width: none;
        }
        .cat-strip::-webkit-scrollbar { display: none; }

        .cat-btn {
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 7px 16px;
            border-radius: 24px;
            border: 1.5px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            white-space: nowrap;
            transition: all .18s;
            letter-spacing: .01em;
        }

        .cat-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        .cat-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 4px 14px rgba(249,115,22,.35);
        }

        .cat-btn-n {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            padding: 0 4px;
            font-size: 10px;
            font-weight: 800;
            background: rgba(255,255,255,.18);
            transition: background .18s;
        }
        .cat-btn:not(.active) .cat-btn-n {
            background: var(--surface2);
            color: var(--text-muted);
        }

        /* ── Ürün Alanı ─── */
        .pos-items {
            flex: 1;
            overflow-y: auto;
            padding: 14px 14px;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        /* Kategori bölüm başlığı (Tümü modunda) */
        .cat-block-title {
            font-size: 10px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .09em;
            padding: 2px 0 9px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cat-block-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .cat-block { margin-bottom: 20px; }

        /* Izgara */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
        }

        /* ── Ürün Kartı ─── */
        .item-card {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 12px 10px 10px;
            border-radius: 12px;
            border: 1.5px solid var(--border);
            background: var(--surface2);
            cursor: pointer;
            user-select: none;
            transition: border-color .15s, background .15s, transform .12s, box-shadow .15s;
            overflow: hidden;
            min-height: 80px;
        }

        .item-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249,115,22,.14);
        }

        /* Sepetteyken → Yeşil */
        .item-card.selected {
            border-color: #22c55e !important;
            background: rgba(34,197,94,.09) !important;
            box-shadow: 0 4px 16px rgba(34,197,94,.2) !important;
        }

        /* Aktif tık parlama efekti */
        .item-card:active { transform: scale(.96); }

        .item-name {
            font-size: 12px;
            font-weight: 600;
            line-height: 1.35;
            color: var(--text);
            /* uzun isimler 2 satırda kesilsin */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }

        .item-price {
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 800;
            color: var(--accent);
        }

        .item-card.selected .item-price { color: #22c55e; }

        /* Adet rozeti — sağ üst */
        .item-qty-badge {
            position: absolute;
            top: 7px;
            right: 7px;
            min-width: 22px;
            height: 22px;
            border-radius: 11px;
            background: #22c55e;
            color: #fff;
            font-family: 'Syne', sans-serif;
            font-size: 11px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            opacity: 0;
            transform: scale(.4);
            transition: opacity .2s, transform .2s cubic-bezier(.34,1.56,.64,1);
            pointer-events: none;
        }

        .item-card.selected .item-qty-badge {
            opacity: 1;
            transform: scale(1);
        }

        /* Boş durum */
        .items-empty {
            display: none;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
            font-size: 14px;
        }
        .items-empty.visible { display: block; }
        .items-empty-icon { font-size: 40px; margin-bottom: 12px; opacity: .4; }

        /* Arama etiketi */
        .search-result-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .06em;
            margin-bottom: 10px;
            display: none;
        }
        .search-result-label.show { display: block; }

        /* ══════════════════════════════════════════════════════════════════
           SAĞ PANEL — Sepet
        ══════════════════════════════════════════════════════════════════ */
        .pos-cart {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid var(--border);
            background: var(--surface);
        }

        /* Sepet başlık */
        .cart-head {
            flex-shrink: 0;
            padding: 13px 16px 11px;
            border-bottom: 1px solid var(--border);
            background: var(--surface2);
        }

        .cart-head-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .cart-title {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cart-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 22px;
            height: 22px;
            border-radius: 11px;
            background: var(--accent);
            color: #fff;
            font-size: 11px;
            font-weight: 800;
            padding: 0 6px;
            transition: transform .2s cubic-bezier(.34,1.56,.64,1);
        }
        .cart-count.pop { animation: countPop .28s cubic-bezier(.34,1.56,.64,1); }
        @@keyframes countPop { 0%,100%{transform:scale(1)} 50%{transform:scale(1.4)} }

        .cart-sub { font-size: 11px; color: var(--text-muted); }

        /* Garson + Not alanları */
        .cart-fields {
            flex-shrink: 0;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .f-group { display: flex; flex-direction: column; gap: 3px; }

        .f-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        .f-input {
            background: var(--surface2);
            border: 1.5px solid var(--border);
            border-radius: 9px;
            padding: 9px 11px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            outline: none;
            width: 100%;
            transition: border-color .15s;
        }
        .f-input:focus { border-color: var(--accent); }
        .f-input.error { border-color: #ef4444; }

        .f-error {
            font-size: 11px;
            color: #ef4444;
            display: none;
        }
        .f-error.show { display: block; }

        /* Ürün listesi */
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .cart-empty {
            text-align: center;
            padding: 32px 12px;
            color: var(--text-muted);
            font-size: 13px;
            line-height: 1.8;
        }
        .cart-empty-icon { font-size: 34px; display: block; opacity: .35; margin-bottom: 8px; }

        /* Sepet kalemi */
        .citem {
            padding: 9px 10px;
            border-radius: 10px;
            background: var(--surface2);
            border: 1.5px solid var(--border);
            margin-bottom: 6px;
            animation: slideIn .16s ease;
        }
        @@keyframes slideIn { from{opacity:0;transform:translateX(10px)} to{opacity:1;transform:translateX(0)} }

        .citem-row1 {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .citem-name {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .citem-qty-ctrl {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .cqbtn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 14px;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: all .12s;
            line-height: 1;
            font-family: monospace;
        }
        .cqbtn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

        .cqbtn.minus:hover { background: #ef4444; border-color: #ef4444; }

        .citem-qty {
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            font-weight: 800;
            min-width: 22px;
            text-align: center;
        }

        .citem-price {
            font-family: 'Syne', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--accent);
            min-width: 52px;
            text-align: right;
            flex-shrink: 0;
        }

        .citem-del {
            width: 22px;
            height: 22px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
            display: grid;
            place-items: center;
            border-radius: 5px;
            transition: all .12s;
            flex-shrink: 0;
            line-height: 1;
        }
        .citem-del:hover { color: #ef4444; background: rgba(239,68,68,.1); }

        .citem-note {
            width: 100%;
            margin-top: 5px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            padding: 5px 9px;
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color .15s, color .15s;
        }
        .citem-note:focus { border-color: var(--accent); color: var(--text); }
        .citem-note::placeholder { color: var(--text-faint); font-size: 11px; }

        /* Alt toplam + buton */
        .cart-foot {
            flex-shrink: 0;
            padding: 12px 14px;
            border-top: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cart-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-total-lbl {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .cart-total-val {
            font-family: 'Syne', sans-serif;
            font-size: 26px;
            font-weight: 900;
            color: var(--accent);
        }
        .cart-total-val.bump { animation: totalBump .22s ease; }
        @@keyframes totalBump { 0%,100%{transform:scale(1)} 50%{transform:scale(1.07)} }

        .btn-open {
            width: 100%;
            padding: 13px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 11px;
            font-size: 15px;
            font-weight: 800;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background .15s, transform .12s, box-shadow .15s;
            letter-spacing: .01em;
        }
        .btn-open:hover:not(:disabled) {
            background: #ea6c0a;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(249,115,22,.4);
        }
        .btn-open:disabled {
            background: var(--surface2);
            color: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Hata alert */
        .pos-alert {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 999;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 13px;
            border: 1px solid rgba(239,68,68,.3);
            background: rgba(239,68,68,.12);
            color: #f87171;
            animation: alertIn .25s ease;
            max-width: 320px;
        }
        @@keyframes alertIn { from{opacity:0;transform:translateX(12px)} to{opacity:1;transform:translateX(0)} }

        /* Responsive */
        @@media (max-width: 800px) {
            .pos-wrap { grid-template-columns: 1fr; height: auto; overflow: visible; }
            .pos-menu { height: 58vh; }
            .pos-cart { border-left: none; border-top: 1px solid var(--border); }
        }
    </style>
}

@if (TempData["Error"] != null)
{
    <div class="pos-alert">❌ @TempData["Error"]</div>
}

<form id="orderForm" asp-controller="Orders" asp-action="Create" method="post"
      onsubmit="return validateOrder()">
    @Html.AntiForgeryToken()
    <input type="hidden" name="tableId" value="@table.TableId" />
    <div id="hiddenInputs"></div>

    <div class="pos-wrap">

        @* ══ SOL — Menü ══ *@
        <div class="pos-menu">

            @* Üst bar *@
            <div class="pos-header">
                <span class="pos-table-chip">🪑 @table.TableName</span>
                <div class="pos-search-wrap">
                    <span class="pos-search-icon">🔍</span>
                    <input type="text" id="searchInput" placeholder="Ürün ara..."
                           oninput="doSearch(this.value)"
                           autocomplete="off" />
                </div>
                <a asp-controller="Tables" asp-action="Index" class="pos-back">← Masalar</a>
            </div>

            @* Kategori şeridi *@
            <div class="cat-strip">
                <button type="button" class="cat-btn active"
                        data-cat="all" onclick="filterCat('all',this)">
                    Tümü
                    <span class="cat-btn-n">@allItems.Count</span>
                </button>
                @foreach (var cat in categories)
                {
                    <button type="button" class="cat-btn"
                            data-cat="cat-@cat.CategoryId"
                            onclick="filterCat('cat-@cat.CategoryId',this)">
                        @cat.CategoryName
                        <span class="cat-btn-n">@cat.MenuItems.Count</span>
                    </button>
                }
            </div>

            @* Ürünler *@
            <div class="pos-items" id="posItems">
                <div class="search-result-label" id="searchLabel"></div>

                @foreach (var cat in categories)
                {
                    <div class="cat-block" id="cat-@cat.CategoryId">
                        <div class="cat-block-title">@cat.CategoryName</div>
                        <div class="items-grid">
                            @foreach (var mi in cat.MenuItems)
                            {
                                <div class="item-card"
                                     id="icard-@mi.MenuItemId"
                                     data-id="@mi.MenuItemId"
                                     data-name="@Html.Raw(mi.MenuItemName.Replace("\"", "&quot;").Replace("'", "&#39;"))"
                                     data-price="@mi.MenuItemPrice.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                     data-cat="cat-@cat.CategoryId"
                                     data-keywords="@mi.MenuItemName.ToLower()"
                                     onclick="addItem(@mi.MenuItemId)">
                                    <div class="item-name">@mi.MenuItemName</div>
                                    <div class="item-price">₺@mi.MenuItemPrice.ToString("N2")</div>
                                    <div class="item-qty-badge" id="badge-@mi.MenuItemId"></div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <div class="items-empty" id="itemsEmpty">
                    <div class="items-empty-icon">🔍</div>
                    Ürün bulunamadı.
                </div>
            </div>

        </div>

        @* ══ SAĞ — Sepet ══ *@
        <div class="pos-cart">

            <div class="cart-head">
                <div class="cart-head-row">
                    <span class="cart-title">
                        Adisyon
                        <span class="cart-count" id="cartCount">0</span>
                    </span>
                </div>
                <div class="cart-sub">@table.TableName · @table.TableCapacity kişilik</div>
            </div>

            <div class="cart-fields">
                <div class="f-group">
                    <label class="f-label">Garson Adı *</label>
                    <input class="f-input" id="inp-garson" name="openedBy"
                           placeholder="Adınızı girin..." maxlength="100"
                           oninput="clearErr('garson')" />
                    <span class="f-error" id="err-garson">Garson adı boş olamaz.</span>
                </div>
                <div class="f-group">
                    <label class="f-label">Masa Notu</label>
                    <input class="f-input" name="orderNote"
                           placeholder="Doğum günü, özel istek..." maxlength="300" />
                </div>
            </div>

            <div class="cart-items" id="cartItems">
                <div class="cart-empty" id="cartEmpty">
                    <span class="cart-empty-icon">🛒</span>
                    Henüz ürün eklenmedi.<br>
                    <small style="font-size:12px;opacity:.7">Soldan bir ürüne tıklayın.</small>
                </div>
            </div>

            <div class="cart-foot">
                <div class="cart-total-row">
                    <span class="cart-total-lbl">Toplam</span>
                    <span class="cart-total-val" id="cartTotal">₺0,00</span>
                </div>
                <button type="submit" class="btn-open" id="btnOpen" disabled>
                    ✓ &nbsp;Adisyonu Aç
                </button>
            </div>

        </div>
    </div>
</form>

@section Scripts {
    <script>
        /* ════════════════════════════════════════════════════════════
           STATE
        ════════════════════════════════════════════════════════════ */
        const basket = {}; // { [id]: { id, name, price, qty, note } }

        /* ════════════════════════════════════════════════════════════
           ÜRÜN EKLE / ÇIKAR
        ════════════════════════════════════════════════════════════ */
        function addItem(id) {
            const card = document.getElementById('icard-' + id);
            if (!card) return;

            const name  = card.dataset.name;
            const price = parseFloat(card.dataset.price);

            if (basket[id]) {
                basket[id].qty++;
            } else {
                basket[id] = { id, name, price, qty: 1, note: '' };
            }

            // Kart → yeşil + rozet
            card.classList.add('selected');
            updateBadge(id);

            // Küçük "tıkladım" geri bildirimi
            card.style.transform = 'scale(.94)';
            setTimeout(() => card.style.transform = '', 120);

            render();
        }

        function removeItem(id) {
            delete basket[id];
            const card = document.getElementById('icard-' + id);
            if (card) {
                card.classList.remove('selected');
                updateBadge(id);
            }
            render();
        }

        function changeQty(id, delta) {
            if (!basket[id]) return;
            basket[id].qty += delta;
            if (basket[id].qty < 1) { removeItem(id); return; }
            updateBadge(id);
            render();
        }

        function updateNote(id, val) {
            if (basket[id]) basket[id].note = val;
            syncHidden();
        }

        function updateBadge(id) {
            const badge = document.getElementById('badge-' + id);
            if (!badge) return;
            const item = basket[id];
            badge.textContent = item ? item.qty : '';
        }

        /* ════════════════════════════════════════════════════════════
           RENDER
        ════════════════════════════════════════════════════════════ */
        function render() {
            const items   = Object.values(basket);
            const container = document.getElementById('cartItems');
            const empty   = document.getElementById('cartEmpty');
            const count   = document.getElementById('cartCount');
            const total   = document.getElementById('cartTotal');
            const btnOpen = document.getElementById('btnOpen');

            // Mevcut citem'leri temizle
            container.querySelectorAll('.citem').forEach(el => el.remove());

            const totalQty = items.reduce((s, i) => s + i.qty, 0);
            const totalAmt = items.reduce((s, i) => s + i.price * i.qty, 0);

            // Count rozeti
            count.textContent = totalQty;
            count.classList.remove('pop');
            void count.offsetWidth;
            count.classList.add('pop');

            if (items.length === 0) {
                empty.style.display = 'block';
                btnOpen.disabled = true;
            } else {
                empty.style.display = 'none';
                btnOpen.disabled = false;

                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'citem';
                    div.innerHTML = `
                        <div class="citem-row1">
                            <span class="citem-name" title="${esc(item.name)}">${esc(item.name)}</span>
                            <div class="citem-qty-ctrl">
                                <button type="button" class="cqbtn minus" onclick="changeQty(${item.id},-1)">−</button>
                                <span class="citem-qty">${item.qty}</span>
                                <button type="button" class="cqbtn" onclick="changeQty(${item.id},1)">+</button>
                            </div>
                            <span class="citem-price">₺${(item.price * item.qty).toFixed(2).replace('.',',')}</span>
                            <button type="button" class="citem-del" onclick="removeItem(${item.id})" title="Kaldır">×</button>
                        </div>
                        <input class="citem-note" type="text"
                               placeholder="Not: acısız, az pişmiş..."
                               value="${esc(item.note)}"
                               oninput="updateNote(${item.id}, this.value)"
                               maxlength="200" />
                    `;
                    container.appendChild(div);
                });
            }

            // Toplam animasyonlu güncelle
            total.classList.remove('bump');
            void total.offsetWidth;
            total.classList.add('bump');
            total.textContent = '₺' + totalAmt.toFixed(2).replace('.', ',');

            syncHidden();
        }

        /* ════════════════════════════════════════════════════════════
           HIDDEN INPUT SYNC
        ════════════════════════════════════════════════════════════ */
        function syncHidden() {
            const cont = document.getElementById('hiddenInputs');
            cont.innerHTML = '';
            Object.values(basket).forEach(item => {
                cont.innerHTML += `
                    <input type="hidden" name="menuItemIds" value="${item.id}" />
                    <input type="hidden" name="quantities"  value="${item.qty}" />
                    <input type="hidden" name="itemNotes"   value="${esc(item.note)}" />
                `;
            });
        }

        /* ════════════════════════════════════════════════════════════
           KATEGORİ FİLTRE
        ════════════════════════════════════════════════════════════ */
        let activeCat = 'all';

        function filterCat(catKey, btn) {
            activeCat = catKey;

            // Arama temizle
            document.getElementById('searchInput').value = '';
            document.getElementById('searchLabel').classList.remove('show');

            // Tab durumu
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Tüm kartları göster / gizle
            document.querySelectorAll('.item-card').forEach(c => c.style.display = '');

            // Kategori bloklarını göster / gizle
            document.querySelectorAll('.cat-block').forEach(block => {
                const show = catKey === 'all' || block.id === catKey;
                block.style.display = show ? '' : 'none';
            });

            document.getElementById('itemsEmpty').classList.remove('visible');
        }

        /* ════════════════════════════════════════════════════════════
           ARAMA
        ════════════════════════════════════════════════════════════ */
        function doSearch(q) {
            q = q.toLowerCase().trim();
            const label = document.getElementById('searchLabel');

            if (!q) {
                // Arama boş → aktif kategoriye dön
                filterCat(activeCat, document.querySelector(`.cat-btn[data-cat="${activeCat}"]`));
                return;
            }

            // Tab aktifliğini kaldır (arama modundayken)
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));

            // Tüm blokları aç
            document.querySelectorAll('.cat-block').forEach(b => b.style.display = '');

            // Kartları filtrele
            let found = 0;
            document.querySelectorAll('.item-card').forEach(card => {
                const match = card.dataset.keywords.includes(q);
                card.style.display = match ? '' : 'none';
                if (match) found++;
            });

            // Boş kalan kategori bloklarını gizle
            document.querySelectorAll('.cat-block').forEach(block => {
                const anyVisible = [...block.querySelectorAll('.item-card')]
                    .some(c => c.style.display !== 'none');
                block.style.display = anyVisible ? '' : 'none';
            });

            label.textContent = `"${q}" — ${found} ürün bulundu`;
            label.classList.toggle('show', true);

            const emptyEl = document.getElementById('itemsEmpty');
            emptyEl.classList.toggle('visible', found === 0);
        }

        // Escape ile aramayı kapat
        document.getElementById('searchInput').addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                e.target.value = '';
                doSearch('');
                e.target.blur();
            }
        });

        /* ════════════════════════════════════════════════════════════
           FORM VALİDASYON
        ════════════════════════════════════════════════════════════ */
        function clearErr(field) {
            if (field === 'garson') {
                document.getElementById('inp-garson').classList.remove('error');
                document.getElementById('err-garson').classList.remove('show');
            }
        }

        function validateOrder() {
            let ok = true;
            const garson = document.getElementById('inp-garson');
            const errG   = document.getElementById('err-garson');

            if (!garson.value.trim()) {
                garson.classList.add('error');
                errG.classList.add('show');
                garson.focus();
                ok = false;
            } else {
                garson.classList.remove('error');
                errG.classList.remove('show');
            }

            if (Object.keys(basket).length === 0) {
                // Küçük alert yerine sepet panelini hafifçe shake yap
                const cart = document.querySelector('.pos-cart');
                cart.style.animation = 'none';
                void cart.offsetWidth;
                cart.style.animation = 'shake .35s ease';
                ok = false;
            }

            return ok;
        }

        // Sepet shake animasyonu
        const shakeStyle = document.createElement('style');
        shakeStyle.textContent = `
        @@keyframes shake {
            0%,100%{transform:translateX(0)}
            20%{transform:translateX(-5px)}
            40%{transform:translateX(5px)}
            60%{transform:translateX(-4px)}
            80%{transform:translateX(4px)}
        }`;
        document.head.appendChild(shakeStyle);

        /* ════════════════════════════════════════════════════════════
           YARDIMCI
        ════════════════════════════════════════════════════════════ */
        function esc(str) {
            return String(str)
                .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        // Alert otomatik kaybol
        setTimeout(() => {
            const a = document.querySelector('.pos-alert');
            if (a) { a.style.transition='opacity .5s'; a.style.opacity='0'; setTimeout(()=>a.remove(),500); }
        }, 3000);
    </script>
}
