@{
    ViewData["Title"] = ViewData["Title"]?.ToString() ?? "Adisyon Aç";
    var table = (Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Table)ViewBag.Table;
    var categories = (List<Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Category>)ViewBag.Categories;
    var allItems = categories.SelectMany(c => c.MenuItems).ToList();
}

@section Styles {
    <link href="~/css/Views/Orders/create.css" rel="stylesheet" asp-append-version="true" />
}

@* JSON Data Island — JS tarafında tableId'yi buradan okur *@
<script type="application/json" id="createPageData">
    {
        "tableId": @table.TableId
    }
</script>

@* AntiForgery token — form submit olmasa bile fetch için gerekli *@
@Html.AntiForgeryToken()

<div class="pos-wrap">

    @* ══ SOL — Menü ══ *@
    <div class="pos-menu">

        @* Üst bar *@
        <div class="pos-header">
            <span class="pos-table-chip">🪑 @table.TableName</span>
            <div class="pos-search-wrap">
                <span class="pos-search-icon">🔍</span>
                <input type="text" id="searchInput" placeholder="Ürün ara..."
                       oninput="doSearch(this.value)"
                       autocomplete="off" />
            </div>
            <a asp-controller="Tables" asp-action="Index" class="pos-back">← Masalar</a>
        </div>

        @* Kategori şeridi *@
        <div class="cat-strip">
            <button type="button" class="cat-btn active"
                    data-cat="all" onclick="filterCat('all',this)">
                Tümü
                <span class="cat-btn-n">@allItems.Count</span>
            </button>
            @foreach (var cat in categories)
            {
                <button type="button" class="cat-btn"
                        data-cat="cat-@cat.CategoryId"
                        onclick="filterCat('cat-@cat.CategoryId',this)">
                    @cat.CategoryName
                    <span class="cat-btn-n">@cat.MenuItems.Count</span>
                </button>
            }
        </div>

        @* Ürünler *@
        <div class="pos-items" id="posItems">
            <div class="search-result-label" id="searchLabel"></div>

            @foreach (var cat in categories)
            {
                @* Kural 2: Stoğu 0 olanlar üste, aktifler alta — kategori içinde sırala *@
                var sortedItems = cat.MenuItems
                .OrderByDescending(m => m.TrackStock && m.StockQuantity <= 0)
                .ToList();

                <div class="cat-block" id="cat-@cat.CategoryId">
                    <div class="cat-block-title">@cat.CategoryName</div>
                    <div class="items-grid">
                        @foreach (var mi in sortedItems)
                        {
                            bool outOfStock = mi.TrackStock && mi.StockQuantity <= 0;
                            <div class="item-card @(outOfStock ? "item-card-disabled" : "")"
                                 id="icard-@mi.MenuItemId"
                                 data-id="@mi.MenuItemId"
                                 data-name="@Html.Raw(mi.MenuItemName.Replace("\"", "&quot;").Replace("'", "&#39;"))"
                                 data-price="@mi.MenuItemPrice.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                 data-cat="cat-@cat.CategoryId"
                                 data-keywords="@mi.MenuItemName.ToLower()"
                                 data-stock="@mi.StockQuantity"
                                 data-track="@mi.TrackStock.ToString().ToLower()"
                                 onclick="addItem(@mi.MenuItemId)">
                                <div class="item-name">
                                    @mi.MenuItemName
                                    @if (outOfStock)
                                    {
                                        <span class="item-no-stock-badge">(Stokta bulunmuyor)</span>
                                    }
                                </div>
                                <div class="item-price">₺@mi.MenuItemPrice.ToString("N2")</div>
                                <div class="item-qty-badge" id="badge-@mi.MenuItemId"></div>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="items-empty" id="itemsEmpty">
                <div class="items-empty-icon">🔍</div>
                Ürün bulunamadı.
            </div>
        </div>

    </div>

    @* ══ SAĞ — Sepet ══ *@
    <div class="pos-cart">

        <div class="cart-head">
            <div class="cart-head-row">
                <span class="cart-title">
                    Adisyon
                    <span class="cart-count" id="cartCount">0</span>
                </span>
            </div>
            <div class="cart-sub">@table.TableName · @table.TableCapacity kişilik</div>
        </div>

        <div class="cart-fields">
            <div class="f-group">
                <label class="f-label">Masa Notu</label>
                <input class="f-input" id="orderNoteInput"
                       placeholder="Doğum günü, özel istek..." maxlength="300" />
            </div>
        </div>

        <div class="cart-items" id="cartItems">
            <div class="cart-empty" id="cartEmpty">
                <span class="cart-empty-icon">🛒</span>
                Henüz ürün eklenmedi.<br>
                <small style="font-size:12px;opacity:.7">Soldan bir ürüne tıklayın.</small>
            </div>
        </div>

        <div class="cart-foot">
            <div class="cart-total-row">
                <span class="cart-total-lbl">Toplam</span>
                <span class="cart-total-val" id="cartTotal">₺0,00</span>
            </div>
            <button type="button" class="btn-open" id="btnOpen" disabled onclick="submitOrder()">
                ✓ &nbsp;Adisyonu Aç
            </button>
        </div>

    </div>
</div>

@* Toast Container — stok uyarıları sağ-alttan çıkar *@
<div id="createToastContainer" class="cr-toast-container"></div>

@section Scripts {
    <script src="~/js/Views/Orders/Create.js" asp-append-version="true"></script>
}
