@{
    ViewData["Title"] = ViewData["Title"]?.ToString() ?? "Adisyon Aç";
    var table = (Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Table)ViewBag.Table;
    var categories = (List<Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Category>)ViewBag.Categories;
    int catIndex = 0;
}

@section Styles {
    <style>
        .order-layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
            align-items: start;
        }

        .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .category-block {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            transition: border-color .2s;
        }

            .category-block:has(.category-head.open) {
                border-color: rgba(249,115,22,.3);
            }

        /* ── Tıklanabilir Kategori Bar ── */
        .category-head {
            padding: 13px 18px;
            background: rgba(255,255,255,0.04);
            font-family: 'Syne', sans-serif;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: .1em;
            text-transform: uppercase;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
            transition: background .15s;
            /* Açıkken alt border gelir */
            border-bottom: 1px solid transparent;
        }

            .category-head:hover {
                background: rgba(249,115,22,.06);
            }

            .category-head.open {
                background: rgba(249,115,22,.08);
                border-bottom-color: var(--border);
            }

        .cat-stripe {
            width: 3px;
            height: 15px;
            background: var(--accent);
            border-radius: 2px;
            flex-shrink: 0;
        }

        .cat-title {
            flex: 1;
        }

        .cat-item-count {
            font-size: 10px;
            font-weight: 600;
            opacity: .5;
            font-family: 'DM Sans', sans-serif;
            letter-spacing: 0;
            text-transform: none;
        }

        /* Chevron ok */
        .cat-chevron {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            opacity: .65;
            transition: transform .3s cubic-bezier(.4,0,.2,1), opacity .15s;
        }

            .cat-chevron svg {
                width: 13px;
                height: 13px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2.5;
                stroke-linecap: round;
                stroke-linejoin: round;
            }

        .category-head.open .cat-chevron {
            transform: rotate(180deg);
            opacity: 1;
        }

        /* ── Animasyonlu İçerik (grid-template-rows tekniği) ── */
        .cat-body {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows .3s cubic-bezier(.4,0,.2,1);
        }

            .cat-body.open {
                grid-template-rows: 1fr;
            }

        .cat-body-inner {
            overflow: hidden;
        }

        .menu-items-list {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 9px;
            border: 1px solid var(--border);
            background: var(--surface2);
            cursor: pointer;
            transition: border-color .15s, background .15s;
        }

            .menu-item-row:hover {
                border-color: var(--accent);
                background: var(--accent-glow);
            }

        .mi-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .mi-price {
            font-family: 'Syne', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .mi-add {
            width: 26px;
            height: 26px;
            border-radius: 7px;
            background: var(--accent);
            color: #fff;
            border: none;
            font-size: 17px;
            display: grid;
            place-items: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: background .15s;
            line-height: 1;
        }

            .mi-add:hover {
                background: #ea6c0a;
            }

        /* ── Sağ Panel ── */
        .order-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            position: sticky;
            top: 76px;
            max-height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
        }

        .order-head {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .order-head-title {
            font-family: 'Syne', sans-serif;
            font-size: 15px;
            font-weight: 700;
        }

        .order-head-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .order-form-fields {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 9px;
            flex-shrink: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        .form-control {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 9px 12px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            outline: none;
            width: 100%;
            transition: border-color .15s;
            box-sizing: border-box;
        }

            .form-control:focus {
                border-color: var(--accent);
            }

        .form-error {
            font-size: 11px;
            color: #ef4444;
            display: none;
            margin-top: 2px;
        }

        .basket {
            padding: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 80px;
        }

        .basket-empty {
            text-align: center;
            padding: 28px 16px;
            color: var(--text-muted);
            font-size: 13px;
            line-height: 1.6;
        }

        .basket-item {
            padding: 9px 10px;
            border-radius: 9px;
            background: var(--surface2);
            border: 1px solid var(--border);
            margin-bottom: 6px;
            animation: fadeIn .18s ease;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .bi-top {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bi-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .bi-qty-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .bi-qty-btn {
            width: 22px;
            height: 22px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 13px;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: background .12s;
            flex-shrink: 0;
        }

            .bi-qty-btn:hover {
                background: var(--accent);
                color: #fff;
                border-color: var(--accent);
            }

        .bi-qty {
            width: 22px;
            text-align: center;
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 13px;
        }

        .bi-total {
            font-family: 'Syne', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--accent);
            min-width: 52px;
            text-align: right;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .bi-remove {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-size: 15px;
            cursor: pointer;
            display: grid;
            place-items: center;
            flex-shrink: 0;
            transition: color .12s;
        }

            .bi-remove:hover {
                color: #ef4444;
            }

        .bi-note {
            width: 100%;
            margin-top: 5px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 11px;
            color: var(--text);
            outline: none;
            font-family: 'DM Sans', sans-serif;
            box-sizing: border-box;
        }

            .bi-note:focus {
                border-color: var(--accent);
            }

        .order-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .total-amount {
            font-family: 'Syne', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: var(--accent);
        }

        .btn-submit {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: background .15s;
        }

            .btn-submit:hover {
                background: #ea6c0a;
            }

            .btn-submit:disabled {
                background: var(--surface2);
                color: var(--text-muted);
                cursor: not-allowed;
            }

        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            border: 1px solid;
            margin-bottom: 16px;
        }

        .alert-error {
            background: rgba(239,68,68,.1);
            border-color: rgba(239,68,68,.3);
            color: #ef4444;
        }

        @@media(max-width:900px) {
            .order-layout {
                grid-template-columns: 1fr
            }

            .order-panel {
                position: static;
                max-height: none;
            }
        }
    </style>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-error">❌ @TempData["Error"]</div>
}

<div class="page-header">
    <div>
        <h1 class="page-title">@table.TableName — Yeni Adisyon</h1>
        <p class="page-sub">Menüden ürün seçin, ardından adisyonu açın</p>
    </div>
    <a asp-controller="Tables" asp-action="Index"
       style="padding:8px 16px;border:1px solid var(--border);border-radius:9px;font-size:13px;color:var(--text-muted);white-space:nowrap;">
        ← Masalara Dön
    </a>
</div>

<form id="orderForm" asp-controller="Orders" asp-action="Create" method="post"
      onsubmit="return validateOrder()">
    @Html.AntiForgeryToken()
    <input type="hidden" name="tableId" value="@table.TableId" />
    <div id="hiddenInputs"></div>

    <div class="order-layout">

        @* ── SOL: Menü — Kategoriler varsayılan KAPALI ── *@
        <div class="menu-panel">
            @foreach (var cat in categories)
            {
                var cid = catIndex++;
                <div class="category-block">
                    @* Başlık bar — varsayılan closed (open class yok) *@
                    <div class="category-head" id="cat-head-@cid" onclick="toggleCategory(@cid)">
                        <div class="cat-stripe"></div>
                        <span class="cat-title">@cat.CategoryName</span>
                        <span class="cat-item-count">@cat.MenuItems.Count ürün</span>
                        <span class="cat-chevron">
                            <svg viewBox="0 0 24 24">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </div>

                    @* İçerik — varsayılan collapsed *@
                    <div class="cat-body" id="cat-body-@cid">
                        <div class="cat-body-inner">
                            <div class="menu-items-list">
                                @foreach (var item in cat.MenuItems)
                                {
                                    <div class="menu-item-row"
                                         onclick="addToBasket(@item.MenuItemId, '@Html.Raw(item.MenuItemName.Replace("'", "\\'"))', @item.MenuItemPrice.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))">
                                        <span class="mi-name">@item.MenuItemName</span>
                                        <span class="mi-price">₺@item.MenuItemPrice.ToString("N2")</span>
                                        <button type="button" class="mi-add">＋</button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (!categories.Any() || !categories.SelectMany(c => c.MenuItems).Any())
            {
                <div style="text-align:center;padding:40px;color:var(--text-muted)">
                    Menüde aktif ürün bulunmuyor. Önce Menü sayfasından ürün ekleyin.
                </div>
            }
        </div>

        @* ── SAĞ: Adisyon Paneli ── *@
        <div class="order-panel">
            <div class="order-head">
                <div class="order-head-title">Adisyon</div>
                <div class="order-head-sub">@table.TableName • @table.TableCapacity kişilik</div>
            </div>

            <div class="order-form-fields">
                <div class="form-group">
                    <label class="form-label">Garson Adı *</label>
                    <input class="form-control" id="inp-garson" name="openedBy"
                           placeholder="Adınızı girin..." maxlength="100" />
                    <span class="form-error" id="err-garson">Garson adı boş olamaz.</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Masa Notu</label>
                    <input class="form-control" name="orderNote"
                           placeholder="Doğum günü, özel istek..." maxlength="300" />
                </div>
            </div>

            <div class="basket" id="basket">
                <div class="basket-empty" id="basketEmpty">
                    Henüz ürün eklenmedi.<br>Soldan ürün seçin.
                </div>
            </div>

            <div class="order-footer">
                <div class="total-row">
                    <span class="total-label">Toplam</span>
                    <span class="total-amount" id="totalAmount">₺0,00</span>
                </div>
                <button type="submit" class="btn-submit" id="submitBtn" disabled>
                    Adisyonu Aç
                </button>
            </div>
        </div>

    </div>
</form>

@section Scripts {
    <script>
        /* ── Kategori Aç/Kapat ── */
        function toggleCategory(id) {
            const head = document.getElementById('cat-head-' + id);
            const body = document.getElementById('cat-body-' + id);
            const opening = !head.classList.contains('open');
            head.classList.toggle('open');
            body.classList.toggle('open');
        }

        /* ── Sepet ── */
        const basket = [];

        function addToBasket(id, name, price) {
            const existing = basket.find(b => b.id === id);
            if (existing) { existing.qty++; }
            else { basket.push({ id, name, price, qty: 1, note: '' }); }
            renderBasket();
        }

        function removeFromBasket(id) {
            const idx = basket.findIndex(b => b.id === id);
            if (idx > -1) basket.splice(idx, 1);
            renderBasket();
        }

        function changeQty(id, delta) {
            const item = basket.find(b => b.id === id);
            if (!item) return;
            item.qty += delta;
            if (item.qty < 1) { removeFromBasket(id); return; }
            renderBasket();
        }

        function updateNote(id, note) {
            const item = basket.find(b => b.id === id);
            if (item) item.note = note;
            syncHiddenInputs();
        }

        function renderBasket() {
            const container = document.getElementById('basket');
            const empty     = document.getElementById('basketEmpty');
            container.querySelectorAll('.basket-item').forEach(el => el.remove());

            if (basket.length === 0) {
                empty.style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
            } else {
                empty.style.display = 'none';
                document.getElementById('submitBtn').disabled = false;

                basket.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'basket-item';
                    div.innerHTML = `
                        <div class="bi-top">
                            <span class="bi-name" title="${escHtml(item.name)}">${escHtml(item.name)}</span>
                            <div class="bi-qty-wrap">
                                <button type="button" class="bi-qty-btn" onclick="changeQty(${item.id},-1)">−</button>
                                <span class="bi-qty">${item.qty}</span>
                                <button type="button" class="bi-qty-btn" onclick="changeQty(${item.id},1)">+</button>
                            </div>
                            <span class="bi-total">₺${(item.price * item.qty).toFixed(2).replace('.',',')}</span>
                            <button type="button" class="bi-remove" onclick="removeFromBasket(${item.id})" title="Kaldır">×</button>
                        </div>
                        <input class="bi-note" type="text" placeholder="Kalem notu (acısız, az pişmiş...)"
                               value="${escHtml(item.note)}"
                               oninput="updateNote(${item.id}, this.value)"
                               maxlength="200" />
                    `;
                    container.appendChild(div);
                });
            }

            updateTotal();
            syncHiddenInputs();
        }

        function updateTotal() {
            const total = basket.reduce((s, b) => s + b.price * b.qty, 0);
            document.getElementById('totalAmount').textContent = '₺' + total.toFixed(2).replace('.', ',');
        }

        function syncHiddenInputs() {
            const container = document.getElementById('hiddenInputs');
            container.innerHTML = '';
            basket.forEach(item => {
                container.innerHTML += `
                    <input type="hidden" name="menuItemIds" value="${item.id}" />
                    <input type="hidden" name="quantities"  value="${item.qty}" />
                    <input type="hidden" name="itemNotes"   value="${escHtml(item.note)}" />
                `;
            });
        }

        function escHtml(str) {
            return String(str)
                .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        function validateOrder() {
            let valid = true;
            const garson    = document.getElementById('inp-garson');
            const errGarson = document.getElementById('err-garson');
            if (!garson.value.trim()) {
                errGarson.style.display = 'block';
                garson.style.borderColor = '#ef4444';
                valid = false;
            } else {
                errGarson.style.display = 'none';
                garson.style.borderColor = '';
            }
            if (basket.length === 0) { alert('Lütfen en az bir ürün ekleyin.'); valid = false; }
            return valid;
        }
    </script>
}
