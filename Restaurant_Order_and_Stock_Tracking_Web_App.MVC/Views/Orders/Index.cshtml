@using Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models
@{
    ViewData["Title"] = "Siparişler";

    // Filtrelenmiş listeler (arama varsa bunlar filtrelidir)
    var activeOrders = (List<Order>)ViewBag.ActiveOrders;
    var pastOrders = (List<Order>)ViewBag.PastOrders;

    // Summary bar için FİLTRELENMEMİŞ gerçek günlük veriler
    var allActiveOrders = (List<Order>)ViewBag.AllActiveOrders;
    var allTodayRevenue = (decimal)ViewBag.AllTodayRevenue;
    var allTodayPaidCount = (int)ViewBag.AllTodayPaidCount;

    var activeTab = ViewData["ActiveTab"]?.ToString() ?? "active";
    var searchTable = ViewBag.SearchTable as string ?? "";

    int MinutesOpen(DateTime openedAt) => (int)(DateTime.UtcNow - openedAt).TotalMinutes;
    string PayMethod(int m) => m switch { 1 => "💳 Kredi Kartı", 2 => "💳 Banka Kartı", 3 => "🔄 Diğer", _ => "💵 Nakit" };
    var today = DateTime.Now.Date;
}

@section Styles {
    <style>
        .summary-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px,1fr));
            gap: 12px;
            margin-bottom: 22px;
        }

        .summary-chip {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform .15s;
            min-width: 0;
            overflow: hidden;
        }

            .summary-chip:hover {
                transform: translateY(-1px);
            }

        .chip-icon {
            font-size: 22px;
            flex-shrink: 0;
        }

        .chip-val {
            font-family: 'Syne', sans-serif;
            font-size: clamp(14px, 3.5vw, 18px);
            font-weight: 800;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .chip-lbl {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toolbar {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .tab-bar {
            display: flex;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px;
        }

        .tab-btn {
            padding: 8px 22px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-muted);
            border: none;
            background: none;
            font-family: 'DM Sans', sans-serif;
            transition: all .15s;
            display: flex;
            align-items: center;
            gap: 7px;
        }

            .tab-btn.active {
                background: var(--accent);
                color: #fff;
            }

        .tab-count {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 20px;
            background: rgba(255,255,255,.2);
        }

        .tab-btn:not(.active) .tab-count {
            background: var(--surface2);
            color: var(--text-muted);
        }

        .search-wrap {
            position: relative;
            flex: 1;
            max-width: 320px;
        }

        .search-icon {
            position: absolute;
            left: 11px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 8px 34px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 9px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            outline: none;
            transition: border-color .15s;
            box-sizing: border-box;
        }

            .search-input:focus {
                border-color: var(--accent);
            }

            .search-input::placeholder {
                color: var(--text-muted);
            }

        .search-clear {
            position: absolute;
            right: 9px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            background: none;
            border: none;
            padding: 2px 4px;
            border-radius: 4px;
        }

            .search-clear:hover {
                color: var(--text);
            }

        .search-hint {
            font-size: 11px;
            color: var(--accent);
            margin-top: 4px;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(290px,1fr));
            gap: 14px;
        }

        .order-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform .15s, box-shadow .15s;
        }

            .order-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 32px rgba(0,0,0,.4);
            }

            .order-card.overdue {
                border-color: rgba(239,68,68,.4);
            }

            .order-card.card-paid {
                border-color: rgba(34,197,94,.2);
            }

        .card-head {
            padding: 13px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .card-head-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-num {
            font-family: 'Syne',sans-serif;
            font-size: 13px;
            font-weight: 800;
            color: var(--text-muted);
        }

        .card-table-name {
            font-family: 'Syne',sans-serif;
            font-size: 15px;
            font-weight: 700;
        }

        .card-head-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-body {
            padding: 13px 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .items-box {
            background: var(--surface2);
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .item-name {
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-price {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            margin-left: 6px;
        }

        .card-foot {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-total {
            font-family: 'Syne',sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: var(--accent);
        }

            .card-total.muted {
                color: var(--text-muted);
            }

        .card-actions {
            display: flex;
            gap: 6px;
        }

        .btn-detail {
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: none;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'DM Sans',sans-serif;
            transition: all .15s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

            .btn-detail:hover {
                color: var(--text);
                border-color: var(--text-muted);
            }

        .status-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: .05em;
            text-transform: uppercase;
            padding: 3px 9px;
            border-radius: 20px;
        }

        .s-open {
            background: var(--accent-glow);
            color: var(--accent);
        }

        .s-preparing {
            background: rgba(234,179,8,.12);
            color: #eab308;
        }

        .s-served {
            background: rgba(34,197,94,.12);
            color: #22c55e;
        }

        .s-paid {
            background: rgba(34,197,94,.12);
            color: #22c55e;
        }

        .s-cancelled {
            background: rgba(239,68,68,.12);
            color: #ef4444;
        }

        .time-badge {
            font-size: 10px;
            background: var(--surface2);
            border: 1px solid var(--border);
            padding: 3px 8px;
            border-radius: 20px;
            color: var(--text-muted);
            white-space: nowrap;
        }

            .time-badge.hot {
                border-color: rgba(239,68,68,.4);
                color: #f87171;
                background: rgba(239,68,68,.08);
            }

        .date-group-header {
            grid-column: 1/-1;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 6px;
        }

        .date-group-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            letter-spacing: .07em;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .date-group-line {
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .date-group-count {
            font-size: 10px;
            color: var(--text-muted);
            background: var(--surface2);
            border: 1px solid var(--border);
            padding: 2px 8px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .pay-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        .pay-method {
            color: var(--text-muted);
        }

        .closed-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .note-box {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--surface2);
            border-radius: 7px;
            padding: 7px 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            border: 1px solid;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background: rgba(34,197,94,.1);
            border-color: rgba(34,197,94,.3);
            color: #22c55e;
        }

        .alert-error {
            background: rgba(239,68,68,.1);
            border-color: rgba(239,68,68,.3);
            color: #ef4444;
        }

        .today-banner {
            background: linear-gradient(135deg,rgba(99,102,241,.12),rgba(168,85,247,.08));
            border: 1px solid rgba(99,102,241,.3);
            border-radius: 12px;
            padding: 11px 16px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }

            .today-banner strong {
                color: var(--accent);
            }

        /* Arama aktifken hafif filtre bildirimi */
        .filter-notice {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--accent);
            background: var(--accent-glow);
            border: 1px solid rgba(249,115,22,.25);
            border-radius: 20px;
            padding: 3px 10px;
            margin-top: 5px;
        }

        @@media(max-width:600px) {
            .orders-grid {
                grid-template-columns: 1fr;
            }

            .summary-bar {
                grid-template-columns: 1fr 1fr;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-wrap {
                max-width: 100%;
            }
        }
    </style>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">✅ @TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-error">❌ @TempData["Error"]</div>
}

<div class="page-header">
    <div>
        <h1 class="page-title">Siparişler</h1>
        <p class="page-sub">Aktif adisyonlar ve bugüne ait geçmiş siparişler</p>
    </div>
</div>

@* ── SUMMARY BAR — Aramayla değişmez, her zaman güncel gerçek veriler ── *@
<div class="summary-bar">
    <div class="summary-chip">
        <div class="chip-icon">🧾</div>
        <div style="min-width:0">
            <div class="chip-val">@allActiveOrders.Count</div>
            <div class="chip-lbl">Aktif Adisyon</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">💰</div>
        <div style="min-width:0">
            <div class="chip-val" style="color:var(--accent)">₺@allActiveOrders.Sum(o => o.OrderTotalAmount).ToString("N2")</div>
            <div class="chip-lbl">Açık Adisyon Toplamı</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">✅</div>
        <div style="min-width:0">
            <div class="chip-val" style="color:#22c55e">@allTodayPaidCount</div>
            <div class="chip-lbl">Bugün Tamamlanan</div>
        </div>
    </div>
    <div class="summary-chip">
        <div class="chip-icon">📈</div>
        <div style="min-width:0">
            <div class="chip-val" style="color:#22c55e">₺@allTodayRevenue.ToString("N2")</div>
            <div class="chip-lbl">Bugün Toplam Kazanç</div>
        </div>
    </div>
</div>

@* Toolbar: Tab + Arama *@
<div class="toolbar">
    <div class="tab-bar">
        <button class="tab-btn @(activeTab == "active" ? "active" : "")" onclick="switchTab('active', this)">
            🔥 Aktif <span class="tab-count">@allActiveOrders.Count</span>
        </button>
        <button class="tab-btn @(activeTab == "past" ? "active" : "")" onclick="switchTab('past', this)">
            📋 Geçmiş <span class="tab-count">@pastOrders.Count</span>
        </button>
    </div>

    <div>
        <form method="get" action="/Orders" id="searchForm" style="display:flex;gap:8px;align-items:center;">
            <input type="hidden" name="tab" id="tabHidden" value="@activeTab" />
            <div class="search-wrap">
                <span class="search-icon">🔍</span>
                <input type="text" name="searchTable" id="searchInput" class="search-input"
                       placeholder="Masa adı ile ara…" value="@searchTable" oninput="onSearchInput()" />
                @if (!string.IsNullOrEmpty(searchTable))
                {
                    <button type="button" class="search-clear" onclick="clearSearch()">✕</button>
                }
            </div>
        </form>
        @if (!string.IsNullOrEmpty(searchTable))
        {
            <div class="filter-notice">🎯 "@searchTable" masası filtreleniyor</div>
        }
    </div>
</div>

@* ── AKTİF SİPARİŞLER ── *@
<div id="tabActive" class="@(activeTab == "active" ? "" : "d-none")">
    @if (!activeOrders.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">🧾</div>
            <p>@(string.IsNullOrEmpty(searchTable) ? "Şu an aktif sipariş yok." : $"'{searchTable}' masasına ait aktif sipariş bulunamadı.")</p>
            <p style="margin-top:6px;font-size:12px">Masalar sayfasından yeni adisyon açabilirsiniz.</p>
        </div>
    }
    else
    {
        <div class="orders-grid">
            @foreach (var order in activeOrders)
            {
                var minutes = MinutesOpen(order.OrderOpenedAt);
                var isHot = minutes > 30;

                var dominantStatus = order.OrderItems.Any()
                ? order.OrderItems.Where(i => i.OrderItemStatus != "cancelled")
                .GroupBy(i => i.OrderItemStatus)
                .OrderByDescending(g => g.Count())
                .FirstOrDefault()?.Key ?? "open"
                : "open";

                string BadgeClass(string s) => s switch { "preparing" => "s-preparing", "served" => "s-served", _ => "s-open" };
                string BadgeLabel(string s) => s switch { "preparing" => "Hazırlanıyor", "served" => "Servis Edildi", _ => "Açık" };

                <div class="order-card @(isHot ? "overdue" : "")">
                    <div class="card-head">
                        <div class="card-head-left">
                            <span class="card-num">#@order.OrderId</span>
                            <span class="card-table-name">🪑 @order.Table?.TableName</span>
                        </div>
                        <div class="card-head-right">
                            <span class="time-badge @(isHot ? "hot" : "")">⏱ @minutes dk</span>
                            <span class="status-badge @BadgeClass(dominantStatus)">@BadgeLabel(dominantStatus)</span>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="card-meta">
                            👤 @order.OrderOpenedBy <span>·</span>
                            <span>🕐 @order.OrderOpenedAt.ToLocalTime().ToString("HH:mm")</span>
                        </div>

                        <div class="items-box">
                            @foreach (var item in order.OrderItems.Where(i => i.OrderItemStatus != "cancelled"))
                            {
                                <div class="item-row">
                                    <span class="item-name">@item.MenuItem?.MenuItemName ×@item.OrderItemQuantity</span>
                                    <span class="item-price">₺@item.OrderItemLineTotal.ToString("N2")</span>
                                </div>
                            }
                        </div>

                        @if (!string.IsNullOrWhiteSpace(order.OrderNote))
                        {
                            <div class="note-box">📝 @order.OrderNote</div>
                        }
                    </div>

                    <div class="card-foot">
                        <span class="card-total">₺@order.OrderTotalAmount.ToString("N2")</span>
                        <div class="card-actions">
                            <a asp-controller="Orders" asp-action="Detail" asp-route-id="@order.OrderId" class="btn-detail">Detay →</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* ── GEÇMİŞ SİPARİŞLER ── *@
<div id="tabPast" class="@(activeTab == "past" ? "" : "d-none")">
    <div class="today-banner">
        📅 Gösterilen siparişler:
        <strong>@today.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"))</strong>
        tarihine ait — Gece yarısı 00:00'da otomatik sıfırlanır
    </div>

    @if (!pastOrders.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">📋</div>
            <p>@(string.IsNullOrEmpty(searchTable) ? "Bugüne ait tamamlanmış sipariş yok." : $"'{searchTable}' masasına ait bugün sipariş bulunamadı.")</p>
        </div>
    }
    else
    {

        // Masa birleştirmesi sonucu oluşan cancelled+toplam=0 adisyonları gizle
        var visiblePast = pastOrders
        .Where(o => !(o.OrderStatus == "cancelled" && o.OrderTotalAmount == 0))
        .ToList();

        var grouped = visiblePast
        .GroupBy(o => o.OrderOpenedAt.ToLocalTime().Date)
        .OrderByDescending(g => g.Key);


        <div class="orders-grid">
            @foreach (var group in grouped)
            {
                var groupDate = group.Key;
                var groupLabel = groupDate == today ? "Bugün" : groupDate.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
                var groupRevenue = group.Where(o => o.OrderStatus == "paid").Sum(o => o.OrderTotalAmount);

                <div class="date-group-header">
                    <div class="date-group-line"></div>
                    <span class="date-group-label">@groupLabel</span>
                    <span class="date-group-count">@group.Count() sipariş · ₺@groupRevenue.ToString("N2")</span>
                    <div class="date-group-line"></div>
                </div>

                @foreach (var order in group.OrderByDescending(o => o.OrderClosedAt))
                {
                    var payment = order.Payments?.FirstOrDefault();
                    var allPayments = order.Payments ?? new List<Payment>();
                    var closedMins = order.OrderClosedAt.HasValue
                    ? (int)(order.OrderClosedAt.Value - order.OrderOpenedAt).TotalMinutes : 0;

                    <div class="order-card @(order.OrderStatus == "paid" ? "card-paid" : "")">
                        <div class="card-head">
                            <div class="card-head-left">
                                <span class="card-num">#@order.OrderId</span>
                                <span class="card-table-name">🪑 @order.Table?.TableName</span>
                            </div>
                            <div class="card-head-right">
                                <span class="time-badge">@closedMins dk</span>
                                <span class="status-badge @(order.OrderStatus == "paid" ? "s-paid" : "s-cancelled")">
                                    @(order.OrderStatus == "paid" ? "Ödendi" : "İptal")
                                </span>
                            </div>
                        </div>

                        <div class="card-body">
                            <div class="card-meta">
                                👤 @order.OrderOpenedBy <span>·</span>
                                <span>🕐 @order.OrderOpenedAt.ToLocalTime().ToString("HH:mm")</span>
                            </div>

                            <div class="items-box">
                                @foreach (var item in order.OrderItems.Where(i => i.OrderItemStatus != "cancelled"))
                                {
                                    <div class="item-row">
                                        <span class="item-name">@item.MenuItem?.MenuItemName ×@item.OrderItemQuantity</span>
                                        <span class="item-price">₺@item.OrderItemLineTotal.ToString("N2")</span>
                                    </div>
                                }
                            </div>

                            @if (allPayments.Any())
                            {
                                <div class="pay-row">
                                    <span class="pay-method">@PayMethod(payment?.PaymentsMethod ?? 0)</span>
                                    @if (payment != null && payment.PaymentsChangeGiven > 0)
                                    {
                                        <span style="color:var(--text-muted);font-size:11px">Para üstü: ₺@payment.PaymentsChangeGiven.ToString("N2")</span>
                                    }
                                </div>
                            }

                            @if (order.OrderClosedAt.HasValue)
                            {
                                <div class="closed-time">🕐 Kapandı: @order.OrderClosedAt.Value.ToLocalTime().ToString("HH:mm")</div>
                            }
                        </div>

                        <div class="card-foot">
                            <span class="card-total @(order.OrderStatus == "cancelled" ? "muted" : "")">
                                ₺@order.OrderTotalAmount.ToString("N2")
                            </span>
                            <a asp-controller="Orders" asp-action="Detail" asp-route-id="@order.OrderId" class="btn-detail">Detay →</a>
                        </div>
                    </div>
                }
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        function switchTab(name, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tabActive').classList.add('d-none');
            document.getElementById('tabPast').classList.add('d-none');
            document.getElementById('tab' + (name === 'active' ? 'Active' : 'Past')).classList.remove('d-none');
            document.getElementById('tabHidden').value = name;
        }

        function onSearchInput() {
            clearTimeout(window._searchTimer);
            window._searchTimer = setTimeout(() => {
                document.getElementById('searchForm').submit();
            }, 600);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchForm').submit();
        }

        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(a => {
                a.style.transition = 'opacity .5s';
                a.style.opacity = '0';
                setTimeout(() => a.remove(), 500);
            });
        }, 3000);
    </script>
}
