@model Restaurant_Order_and_Stock_Tracking_Web_App.MVC.ViewModels.Reports.WasteReportViewModel
@{
    ViewData["Title"] = "İptal & Fire Raporu";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var f = Model.Filter;
}

@section Styles {
    <link href="~/css/Views/Reports/Cancelandwaste.css" rel="stylesheet" asp-append-version="true" />
}

<div class="rpt-page-header">
    <div>
        <h1>🗑️ İptal & Fire Raporu</h1>
        <div class="sub">@f.DisplayRange</div>
    </div>
    <button class="btn-csv" id="btnCsv">📥 CSV İndir</button>
</div>

<div class="filter-bar">
    <button class="preset-btn @(f.Preset == "today" ? "active" : "")" data-preset="today">Bugün</button>
    <button class="preset-btn @(f.Preset == "week" ? "active" : "")" data-preset="week">Son 7 Gün</button>
    <button class="preset-btn @(f.Preset == "month" ? "active" : "")" data-preset="month">Son 30 Gün</button>
    <button class="preset-btn @(f.Preset == "custom" ? "active" : "")" data-preset="custom">Özel</button>
    <div class="filter-sep"></div>
    <input type="date" id="dateFrom" class="filter-date" value="@f.From.ToString("yyyy-MM-dd")" style="display:@(f.Preset == "custom" ? "" : "none")" />
    <input type="date" id="dateTo" class="filter-date" value="@f.To.AddDays(-1).ToString("yyyy-MM-dd")" style="display:@(f.Preset == "custom" ? "" : "none")" />
</div>

<!-- ── Özet Kartlar ── -->
<div class="sum-grid">
    <div class="sum-card red">
        <div class="sum-val">₺@Model.TotalWasteLoss.ToString("N2")</div>
        <div class="sum-label">Toplam Fire Tutarı</div>
    </div>
    <div class="sum-card amber">
        <div class="sum-val">₺@Model.OrderWasteTotal.ToString("N2")</div>
        <div class="sum-label">Sipariş Kaynaklı Fire</div>
    </div>
    <div class="sum-card blue">
        <div class="sum-val">₺@Model.StockLogWasteTotal.ToString("N2")</div>
        <div class="sum-label">Stok Kaynaklı Fire</div>
    </div>
</div>

<!-- ── Grafikler ── -->
<div class="chart-row">
    <div class="chart-card">
        <div class="chart-card-title">🔵 Kaynak Dağılımı</div>
        <div class="chart-container">
            <canvas id="wasteSourceChart"></canvas>
            <div class="loading-overlay" id="sourceLoading">Yükleniyor…</div>
        </div>
    </div>
    <div class="chart-card">
        <div class="chart-card-title">📦 En Çok Fire Veren 10 Ürün</div>
        <div class="chart-container">
            <canvas id="wasteProductChart"></canvas>
            <div class="loading-overlay" id="productLoading">Yükleniyor…</div>
        </div>
    </div>
</div>

<!-- ── Sipariş Kaynaklı Fire Tablosu ── -->
<div class="acc-section">
    <div class="acc-header" onclick="toggleAcc(this)">
        <span>🧾 Sipariş Kaynaklı Fireler</span>
        <span class="count">@Model.OrderWastes.Count kayıt ▼</span>
    </div>
    <div class="acc-body">
        @* BUG 4 DÜZELTMESİ: Sipariş Kaynaklı — Adisyon No sütunu eklendi *@
        @if (Model.OrderWastes.Any())
        {
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Ürün</th>
                        <th>Adisyon No</th>
                        <th>Miktar</th>
                        <th>Birim Fiyat</th>
                        <th>Toplam Kayıp</th>
                        <th>İptal Nedeni</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var w in Model.OrderWastes)
                    {
                        <tr>
                            <td style="color:var(--text-muted); font-size:12px;">@w.Date.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</td>
                            <td>@w.ProductName</td>
                            @* BUG 4: Sipariş kaynaklı → Adisyon No göster, stok notu yok *@
                            <td>
                                @if (w.OrderId.HasValue)
                                {
                                    <span style="font-family:'Syne',sans-serif;font-weight:700;color:var(--accent);">#@w.OrderId</span>
                                }
                                else
                                {
                                    <span style="color:var(--text-muted);">—</span>
                                }
                            </td>
                            <td><span class="pill-amber">@w.Quantity</span></td>
                            <td>₺@w.UnitPrice.ToString("N2")</td>
                            <td><span class="pill-red">₺@w.TotalLoss.ToString("N2")</span></td>
                            <td style="color:var(--text-muted);">@(string.IsNullOrEmpty(w.CancelReason) ? "—" : w.CancelReason)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">Bu dönemde sipariş kaynaklı fire kaydı yok.</div>
        }
    </div>
</div>

<!-- ── Stok Log Kaynaklı Fire Tablosu ── -->
<div class="acc-section">
    <div class="acc-header" onclick="toggleAcc(this)">
        <span>📦 Stok Hareketi Kaynaklı Fireler</span>
        <span class="count">@Model.StockLogWastes.Count kayıt ▼</span>
    </div>
    <div class="acc-body">
        @* BUG 4 DÜZELTMESİ: Stok Kaynaklı — Adisyon No sütunu YOK, Note (fire nedeni) gösterilir *@
        @if (Model.StockLogWastes.Any())
        {
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Ürün</th>
                        <th>Miktar</th>
                        <th>Birim Fiyat</th>
                        <th>Toplam Kayıp</th>
                        @* BUG 4: Stok kaynaklı → Adisyon No yok, fire nedeni (Note) göster *@
                        <th>Fire Nedeni (Stok Notu)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var w in Model.StockLogWastes)
                    {
                        <tr>
                            <td style="color:var(--text-muted); font-size:12px;">@w.Date.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</td>
                            <td>@w.ProductName</td>
                            <td><span class="pill-amber">@w.Quantity</span></td>
                            <td>₺@w.UnitPrice.ToString("N2")</td>
                            <td><span class="pill-red">₺@w.TotalLoss.ToString("N2")</span></td>
                            <td style="color:var(--text-muted);">
                                @if (string.IsNullOrEmpty(w.Note))
                                {
                                    <span style="opacity:.4;">—</span>
                                }
                                else
                                {
                                    <span title="@w.Note">@w.Note</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">Bu dönemde stok kaynaklı fire kaydı yok.</div>
        }
    </div>
</div>
@* Filtre verilerini JSON adacığı olarak JS'e aktar *@
<script id="wasteReportConfig" type="application/json">
    {
        "preset": "@f.Preset",
        "from": "@f.From.ToString("yyyy-MM-dd")",
        "to": "@f.To.AddDays(-1).ToString("yyyy-MM-dd")"
    }
</script>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/Views/Reports/Cancelandwaste.js" asp-append-version="true"></script>
}