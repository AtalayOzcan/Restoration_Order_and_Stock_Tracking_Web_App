@model Restaurant_Order_and_Stock_Tracking_Web_App.MVC.ViewModels.Reports.ReportsDashboardViewModel
@{
    ViewData["Title"] = "Raporlar";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        /* ── Dashboard değişkenleri — site.css'i ezmez ── */
        :root {
            --r-kpi-radius: 14px;
            --r-chart-radius: 12px;
        }

        .rpt-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

            .rpt-page-header h1 {
                font-family: 'Syne', sans-serif;
                font-size: 22px;
                font-weight: 700;
            }

            .rpt-page-header .sub {
                font-size: 12px;
                color: var(--text-muted);
                margin-top: 3px;
            }

        .rpt-refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 16px;
            background: var(--accent);
            color: #fff;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: opacity .2s;
        }

            .rpt-refresh-btn:hover {
                opacity: .85;
            }

        /* ── KPI grid ─────────────────────────────── */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @@media (max-width: 900px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @@media (max-width: 520px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        .kpi-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r-kpi-radius);
            padding: 20px;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: transform .18s, box-shadow .18s;
        }

            .kpi-card:hover {
                transform: translateY(-3px);
                box-shadow: var(--shadow);
            }

        .kpi-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .kpi-value {
            font-family: 'Syne', sans-serif;
            font-size: 26px;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .kpi-accent .kpi-value {
            color: var(--accent);
        }

        .kpi-green .kpi-value {
            color: #10b981;
        }

        .kpi-amber .kpi-value {
            color: #f59e0b;
        }

        .kpi-red .kpi-value {
            color: #ef4444;
        }

        .kpi-blue .kpi-value {
            color: #3b82f6;
        }

        .kpi-purple .kpi-value {
            color: #8b5cf6;
        }

        /* ── Charts & Tables row ──────────────────── */
        .rpt-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        @@media (max-width: 960px) {
            .rpt-row {
                grid-template-columns: 1fr;
            }
        }

        .rpt-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--r-chart-radius);
            padding: 20px;
        }

        .rpt-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

            .rpt-card-title a {
                font-size: 11px;
                font-weight: 500;
                color: var(--accent);
            }

        /* ── Mini table ──────────────────────────── */
        .mini-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

            .mini-table th {
                padding: 6px 10px;
                color: var(--text-muted);
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: .05em;
                border-bottom: 1px solid var(--border);
                text-align: left;
            }

            .mini-table td {
                padding: 8px 10px;
                border-bottom: 1px solid var(--border);
                color: var(--text);
            }

            .mini-table tr:last-child td {
                border-bottom: none;
            }

            .mini-table tr:hover td {
                background: var(--surface2);
            }

        /* ── Critical badge ──────────────────────── */
        .badge-red {
            display: inline-block;
            background: rgba(239,68,68,.12);
            color: #ef4444;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 20px;
        }

        .badge-amber {
            display: inline-block;
            background: rgba(245,158,11,.12);
            color: #f59e0b;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .chart-container {
            position: relative;
            height: 200px;
        }
    </style>
}

<div class="rpt-page-header">
    <div>
        <h1>📈 Raporlar Paneli</h1>
        <div class="sub">Son güncelleme: @Model.LastRefreshedAt.ToString("dd.MM.yyyy HH:mm")</div>
    </div>
    <button class="rpt-refresh-btn" onclick="location.reload()">🔄 Yenile</button>
</div>

<!-- ── KPI Kartları ── -->
<div class="kpi-grid">
    <a class="kpi-card kpi-accent" href="/Reports/Sales?preset=today">
        <div class="kpi-icon">💰</div>
        <div class="kpi-value">₺@Model.TodayGrossSales.ToString("N2")</div>
        <div class="kpi-label">Bugünkü Brüt Ciro</div>
    </a>
    <a class="kpi-card kpi-green" href="/Reports/Sales?preset=today">
        <div class="kpi-icon">🏦</div>
        <div class="kpi-value">₺@Model.TodayNetCollected.ToString("N2")</div>
        <div class="kpi-label">Bugünkü Tahsilat</div>
    </a>
    <a class="kpi-card @(Model.OpenOrderCount > 0 ? "kpi-amber" : "")" href="/Orders">
        <div class="kpi-icon">🧾</div>
        <div class="kpi-value">@Model.OpenOrderCount</div>
        <div class="kpi-label">Açık Adisyon</div>
    </a>
    <a class="kpi-card @(Model.CriticalStockCount > 0 ? "kpi-red" : "")" href="/Stock">
        <div class="kpi-icon">📦</div>
        <div class="kpi-value">@Model.CriticalStockCount</div>
        <div class="kpi-label">Kritik Stok Ürünü</div>
    </a>
    <a class="kpi-card kpi-blue" href="/Reports/CancelAndWaste?preset=today">
        <div class="kpi-icon">🗑️</div>
        <div class="kpi-value">₺@Model.TodayWasteAmount.ToString("N2")</div>
        <div class="kpi-label">Bugünkü Fire Tutarı</div>
    </a>
    <a class="kpi-card kpi-purple" href="/Reports/Table?preset=today">
        <div class="kpi-icon">⏱️</div>
        <div class="kpi-value">@Model.AvgOrderDurationMinutes.ToString("F0") dk</div>
        <div class="kpi-label">Ort. Adisyon Süresi</div>
    </a>
</div>

<!-- ── Chart + Kritik Stok ── -->
<div class="rpt-row">
    <div class="rpt-card">
        <div class="rpt-card-title">
            <span>📊 Bugünkü Saatlik Ciro</span>
            <a href="/Reports/Sales?preset=today">Detay →</a>
        </div>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
    <div class="rpt-card">
        <div class="rpt-card-title">
            <span>🚨 Kritik Stok</span>
            <a href="/Stock">Tümünü Gör →</a>
        </div>
        @if (Model.CriticalStockItems.Any())
        {
            <table class="mini-table">
                <thead>
                    <tr>
                        <th>Ürün</th>
                        <th>Stok</th>
                        <th>Eşik</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.CriticalStockItems)
                    {
                        <tr>
                            <td>@item.ProductName</td>
                            <td><span class="badge-red">@item.CurrentStock</span></td>
                            <td>@item.CriticalThreshold</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">✅ Kritik stok yok</div>
        }
    </div>
</div>

<!-- ── En Çok Satanlar ── -->
<div class="rpt-card">
    <div class="rpt-card-title">
        <span>🏆 Bugünün En Çok Satan 5 Ürünü</span>
        <a href="/Reports/Sales?preset=today">Satış Raporu →</a>
    </div>
    @if (Model.TopProductsToday.Any())
    {
        <table class="mini-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ürün</th>
                    <th>Kategori</th>
                    <th>Adet</th>
                    <th>Ciro</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int rank = 1;
                }
                @foreach (var p in Model.TopProductsToday)
                {
                    <tr>
                        <td style="color: var(--text-muted);">@rank</td>
                        <td>@p.ProductName</td>
                        <td style="color: var(--text-muted);">@p.CategoryName</td>
                        <td><span class="badge-amber">@p.Quantity</span></td>
                        <td>₺@p.Revenue.ToString("N2")</td>
                    </tr>
                    rank++;
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="empty-state">Bugün henüz satış yok.</div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const serverHourly = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.HourlySales));

            const labels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2,'0')}:00`);
            const data   = labels.map((_, h) => {
                const found = serverHourly.find(x => x.hour === h);
                return found ? found.amount : 0;
            });

            const isDark    = document.documentElement.dataset.theme !== 'light';
            const gridColor = isDark ? 'rgba(255,255,255,.06)' : 'rgba(0,0,0,.06)';
            const textColor = isDark ? '#687080' : '#8A95A3';

            const ctx = document.getElementById('hourlyChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Ciro (₺)',
                        data,
                        backgroundColor: 'rgba(249,115,22,.75)',
                        borderColor: '#F97316',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor, maxRotation: 0 } },
                        y: {
                            grid: { color: gridColor },
                            ticks: { color: textColor, callback: v => `₺${v}` }
                        }
                    }
                }
            });
        })();
    </script>
}
