@model IEnumerable<Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Table>
@using Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models
@{
    ViewData["Title"] = "Masalar";
    string StatusClass(int s) => s switch { 1 => "occupied", 2 => "reserved", _ => "available" };
    string StatusLabel(int s) => s switch { 1 => "Dolu", 2 => "Rezerve", _ => "Boş" };
    string StatusDot(int s)   => s switch { 1 => "●", 2 => "◈", _ => "○" };

    // Dolu masaların listesi (birleştirme modalı için kaynak olabilecekler)
    var occupiedTables = Model.Where(t => t.TableStatus == 1).ToList();
}

@section Styles {
     <link href="~/css/Views/Tables/Index.css" rel="stylesheet" asp-append-version="true" />
}

<div class="toast-container" id="toastContainer"></div>

@if (TempData["Success"] != null) { <div class="alert alert-success">✅ @TempData["Success"]</div> }
@if (TempData["Error"]   != null) { <div class="alert alert-error">❌ @TempData["Error"]</div> }

<div class="page-header">
    <div>
        <h1 class="page-title">Masa Yönetimi</h1>
        <p class="page-sub">Masaya tıklayarak adisyon aç veya rezerve et</p>
    </div>
    <div class="toolbar">
        <div class="filter-btns">
            <button class="filter-btn active" data-filter="all">Tümü</button>
            <button class="filter-btn" data-filter="available">Boş</button>
            <button class="filter-btn" data-filter="occupied">Dolu</button>
            <button class="filter-btn" data-filter="reserved">Rezerve</button>
        </div>
        @if (User.IsInRole("Admin"))
{
        <button class="btn-add" onclick="openModal('addModal')">＋ Masa Ekle</button>
}
    </div>
</div>

<div class="summary-bar">
    <div class="summary-chip"><div class="chip-icon">🪑</div><div><div class="chip-val">@Model.Count()</div><div class="chip-lbl">Toplam Masa</div></div></div>
    <div class="summary-chip"><div class="chip-icon">🔴</div><div><div class="chip-val" style="color:#fb923c">@Model.Count(t => t.TableStatus == 1)</div><div class="chip-lbl">Dolu</div></div></div>
    <div class="summary-chip"><div class="chip-icon">🟢</div><div><div class="chip-val" style="color:#4ade80">@Model.Count(t => t.TableStatus == 0)</div><div class="chip-lbl">Boş</div></div></div>
    <div class="summary-chip"><div class="chip-icon">🔵</div><div><div class="chip-val" style="color:#60a5fa">@Model.Count(t => t.TableStatus == 2)</div><div class="chip-lbl">Rezerve</div></div></div>
</div>

@if (!Model.Any())
{
    <div class="empty-state"><div class="empty-icon">🪑</div><p>Henüz masa eklenmemiş.</p></div>
}
else
{
    <div class="tables-grid" id="tablesGrid">
        @foreach (var table in Model)
        {
            var sc           = StatusClass(table.TableStatus);
            var localResTime = table.ReservationTime?.ToLocalTime();
            var warningSoon  = table.TableStatus == 2
                && localResTime.HasValue
                && localResTime.Value <= DateTime.Now.AddMinutes(30)
                && localResTime.Value >= DateTime.Now;

            @* ✅ #5: Dolu masadaki sipariş kalemleri — birleştirilmiş (aynı ürün toplanmış) *@
            var openOrder    = table.Orders?.FirstOrDefault(o => o.OrderStatus == "open");
            var mergedItems  = openOrder?.OrderItems
                .Where(i => i.OrderItemStatus != "cancelled")
                .GroupBy(i => i.MenuItemId)
                .Select(g => new {
                    Name = g.First().MenuItem?.MenuItemName ?? "?",
                    Qty  = g.Sum(x => x.OrderItemQuantity)
                })
                .OrderBy(x => x.Name)
                .ToList();
            var itemCount    = mergedItems?.Count ?? 0;
            var showLimit    = 5;

<div class="table-card @sc @(warningSoon ? "warning-soon" : "") @(table.IsWaiterCalled ? "waiter-called" : "")"
     data-status="@sc"
     data-table-id="@table.TableId"
     data-table-name="@table.TableName">

    @* Zil ikonu — sadece IsWaiterCalled == true ise görünür *@
    @if (table.IsWaiterCalled)
    {
        <div class="waiter-bell-badge">🔔 Garson!</div>
    }

    <div class="card-name">@table.TableName</div>
                <div class="card-status">@StatusDot(table.TableStatus) @StatusLabel(table.TableStatus)</div>
                <div class="card-capacity">👥 @table.TableCapacity kişilik</div>
                <div class="card-divider"></div>

                @* ✅ #5: Kart içi sipariş kalemleri (sadece dolu masada) *@
                @if (table.TableStatus == 1 && mergedItems != null && mergedItems.Any())
                {
                    <div class="order-items-preview" id="items-@table.TableId">
                        @for (int i = 0; i < mergedItems.Count; i++)
                        {
                            var mi = mergedItems[i];
                            <div class="order-items-line @(i >= showLimit ? "order-items-hidden" : "")"
                                 data-item-index="@i">
                                <span class="order-items-name">@mi.Name</span>
                                <span class="order-items-qty">×@mi.Qty</span>
                            </div>
                        }
                        @if (itemCount > showLimit)
                        {
                            <div class="order-items-more" id="more-@table.TableId"
                                 onclick="toggleItems('@table.TableId', @itemCount, @showLimit)">
                                +@(itemCount - showLimit) kalem daha...
                            </div>
                        }
                    </div>
                }

                @* Rezervasyon özet *@
                @if (table.TableStatus == 2 && table.ReservationName != null)
                {
                    <div class="res-summary" onclick="showResDetail('@table.TableId')">
                        <div class="res-summary-name">👤 @table.ReservationName</div>
                        <div class="res-summary-time">
                            🕐 @localResTime?.ToString("HH:mm") — @table.ReservationGuestCount kişi
                            @if (warningSoon) { <span class="res-warning-badge">⚠ Yaklaşıyor</span> }
                        </div>
                    </div>
                }

                <div class="card-actions">
                    @if (table.TableStatus == 0)
                    {
                        <a asp-controller="Orders" asp-action="Create"
                           asp-route-tableId="@table.TableId"
                           class="card-btn primary">Adisyon Aç</a>
                        <button class="card-btn secondary"
                                onclick="openReserveModal(@table.TableId, '@table.TableName', @table.TableCapacity)">
                            Rezerve Et
                        </button>
                    }
                    else if (table.TableStatus == 1)
                    {
                        <a asp-controller="Orders" asp-action="Create"
                           asp-route-tableId="@table.TableId"
                           class="card-btn primary">Adisyona Git →</a>
                        @* ✅ #4: Birleştirme butonu — sadece dolu masalarda *@
                        <button class="card-btn merge"
                                onclick="openMergeModal(@table.TableId, '@table.TableName')">
                            ⇄ Masayı Birleştir
                        </button>
                    }
                    else if (table.TableStatus == 2)
                    {
                        <a asp-controller="Orders" asp-action="Create"
                           asp-route-tableId="@table.TableId"
                           class="card-btn primary">Adisyon Aç</a>
                        <button type="button" class="card-btn secondary"
                                onclick="cancelReserve(@table.TableId)">Rezervasyonu İptal Et</button>
                    }

                    @if (table.TableStatus != 1)
                    {
                        <button type="button" class="card-btn danger"
                                onclick="deleteTable(@table.TableId, '@Html.Raw(table.TableName.Replace("'", "\\'"))')">Sil</button>
                    }
                    
 @if (table.IsWaiterCalled)
    {
        <button type="button" class="card-btn dismiss-waiter"
                onclick="dismissWaiter('@Html.Raw(table.TableName.Replace("'", "\\'"))')">
            ✅ İlgilenildi (Tamam)
        </button>
    }


                </div>
            </div>
        }
    </div>
}
@if (User.IsInRole("Admin"))
    {
@* ── MASA EKLE MODAL ── *@
<div class="modal-overlay" id="addModal">
    <div class="modal">
        <div class="modal-title">Yeni Masa Ekle</div>
        @Html.AntiForgeryToken()
        <div class="form-group">
            <label class="form-label">Masa Adı *</label>
            <input class="form-control" id="add-name" placeholder="Masa 1, Teras-2 ..." maxlength="20" />
            <span class="form-error" id="err-add-name">Masa adı boş olamaz.</span>
        </div>
        <div class="form-group">
            <label class="form-label">Kapasite *</label>
            <input class="form-control" id="add-cap" type="number" min="1" max="20" value="4" />
            <span class="form-error" id="err-add-cap">1 ile 20 arasında olmalıdır.</span>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost" onclick="closeModal('addModal')">İptal</button>
            <button type="button" class="btn-primary" onclick="submitCreateTable()">Ekle</button>
        </div>
    </div>
</div>
}
@* ── REZERVE ET MODAL ── *@
<div class="modal-overlay" id="reserveModal">
    <div class="modal">
        <div class="modal-title" id="res-modal-title">Rezervasyon</div>
        <div class="modal-sub"  id="res-modal-sub">Müşteri bilgilerini giriniz</div>
        @Html.AntiForgeryToken()
        <input type="hidden" id="res-tableId" />
        <input type="hidden" id="res-maxCap"  value="" />
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">İsim Soyisim *</label>
                <input class="form-control" id="res-name" placeholder="Ahmet Yılmaz" maxlength="100" />
                <span class="form-error" id="err-res-name">Ad soyad boş olamaz.</span>
            </div>
            <div class="form-group">
                <label class="form-label">Telefon *</label>
                <input class="form-control" id="res-phone" placeholder="05xx xxx xx xx" maxlength="20" />
                <span class="form-error" id="err-res-phone">Telefon numarası boş olamaz.</span>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Kişi Sayısı *</label>
                <input class="form-control" id="res-guests" type="number" min="1" value="2" />
                <span class="form-error" id="err-res-guests">Geçerli bir kişi sayısı girin.</span>
            </div>
            <div class="form-group">
                <label class="form-label">Rezervasyon Saati *</label>
                <input class="form-control" id="res-time" type="time" />
                <span class="form-error" id="err-res-time">Geçerli bir saat seçiniz.</span>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost" onclick="closeModal('reserveModal')">İptal</button>
            <button type="button" class="btn-primary" onclick="submitReserve()">Rezerve Et</button>
        </div>
    </div>
</div>

@* ── ✅ #4: MASA BİRLEŞTİRME MODAL ── *@
<div class="modal-overlay" id="mergeModal">
    <div class="modal">
        <div class="modal-title">⇄ Masa Birleştir</div>
        <div class="modal-sub" id="merge-sub">Hangi masayla birleştirmek istiyorsunuz?</div>

        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border)">
            <span style="font-size:18px">🪑</span>
            <div>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:600;">Kaynak Masa</div>
                <div style="font-size:15px;font-weight:700" id="merge-source-name">—</div>
            </div>
        </div>

        <div class="merge-arrow">↓ birleştirilecek</div>

        <div class="form-group" style="margin-top:12px">
            <label class="form-label">Hedef Masayı Seçin *</label>
            <div class="merge-table-select" id="mergeTargetList">
                @* JS ile doldurulacak *@
            </div>
        </div>

        @Html.AntiForgeryToken()
        <input type="hidden" id="merge-sourceTableId" />
        <input type="hidden" id="merge-targetTableId" />
        <div class="modal-footer">
            <button type="button" class="btn-ghost" onclick="closeModal('mergeModal')">İptal</button>
            <button type="button" class="btn-primary" id="merge-submit-btn" disabled
                    onclick="submitMerge()">
                ⇄ Birleştir
            </button>
        </div>
    </div>
</div>

@* ── REZERVASYON DETAY MODAL ── *@
<div class="modal-overlay" id="resDetailModal">
    <div class="modal" style="width:360px">
        <div class="modal-title">Rezervasyon Detayı</div>
        <div id="resDetailContent" style="margin:16px 0"></div>
        <div class="modal-footer">
            <button class="btn-ghost" onclick="closeModal('resDetailModal')">Kapat</button>
        </div>
    </div>
</div>

@* Rezervasyon verisi *@
<script id="reservationData" type="application/json">
@Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    Model.Where(t => t.TableStatus == 2 && t.ReservationTime.HasValue)
         .Select(t => new {
             id        = t.TableId,
             name      = t.TableName,
             resName   = t.ReservationName,
             resPhone  = t.ReservationPhone,
             resGuests = t.ReservationGuestCount,
             resTime    = t.ReservationTime!.Value.ToLocalTime().ToString("HH:mm"),
             resTimeIso = t.ReservationTime!.Value.ToLocalTime().ToString("yyyy-MM-ddTHH:mm:ss")
         })
))
</script>

@* ✅ #4: Tüm masaları JS'e ver (birleştirme hedef listesi için) *@
<script id="allTablesData" type="application/json">
@Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    Model.Select(t => new {
        id     = t.TableId,
        name   = t.TableName,
        status = t.TableStatus,
        total  = t.Orders?.FirstOrDefault(o => o.OrderStatus == "open")?.OrderTotalAmount ?? 0,
        itemCount = t.Orders?.FirstOrDefault(o => o.OrderStatus == "open")
                    ?.OrderItems.Count(i => i.OrderItemStatus != "cancelled") ?? 0
    })
))
</script>

@section Scripts {
    @* SignalR istemci kütüphanesi — CDN üzerinden (veya libman ile wwwroot'a alabilirsiniz) *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="~/js/Views/Tables/Index.js" asp-append-version="true"></script>
}
