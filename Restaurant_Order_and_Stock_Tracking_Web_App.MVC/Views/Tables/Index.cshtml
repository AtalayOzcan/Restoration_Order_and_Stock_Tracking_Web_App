@model IEnumerable<Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models.Table>
@using Restaurant_Order_and_Stock_Tracking_Web_App.MVC.Models
@{
    ViewData["Title"] = "Masalar";
    string StatusClass(int s) => s switch { 1 => "occupied", 2 => "reserved", _ => "available" };
    string StatusLabel(int s) => s switch { 1 => "Dolu", 2 => "Rezerve", _ => "Boş" };
    string StatusDot(int s)   => s switch { 1 => "●", 2 => "◈", _ => "○" };

    // Dolu masaların listesi (birleştirme modalı için kaynak olabilecekler)
    var occupiedTables = Model.Where(t => t.TableStatus == 1).ToList();
}

@section Styles {
<style>
    .summary-bar { display:flex; gap:12px; margin-bottom:22px; flex-wrap:wrap; }
    .summary-chip { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 18px; display:flex; align-items:center; gap:12px; flex:1; min-width:130px; }
    .chip-icon { font-size:22px; }
    .chip-val  { font-family:'Syne',sans-serif; font-size:22px; font-weight:700; }
    .chip-lbl  { font-size:11px; color:var(--text-muted); margin-top:1px; }

    .toolbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .filter-btns { display:flex; gap:6px; }
    .filter-btn { padding:6px 14px; border-radius:20px; border:1px solid var(--border); background:var(--surface2); color:var(--text-muted); font-size:12px; font-weight:600; cursor:pointer; transition:all .15s; }
    .filter-btn:hover,.filter-btn.active { border-color:var(--accent); color:var(--accent); background:var(--accent-glow); }
    .btn-add { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; background:var(--accent); color:#fff; border-radius:9px; font-size:13px; font-weight:700; border:none; cursor:pointer; transition:background .15s; }
    .btn-add:hover { background:#ea6c0a; }

    .tables-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; }

    .table-card { border-radius:14px; border:1.5px solid; padding:16px; display:flex; flex-direction:column; gap:8px; position:relative; transition:transform .15s,box-shadow .15s; }
    .table-card:hover { transform:translateY(-3px); box-shadow:0 8px 28px rgba(0,0,0,.3); }
    .table-card.available { background:#0f2318; border-color:#166534; }
    .table-card.occupied  { background:#2a1200; border-color:#c2410c; }
    .table-card.reserved  { background:#0d1a2e; border-color:#1d4ed8; }
    [data-theme="light"] .table-card.available { background:#f0fdf4; border-color:#86efac; }
    [data-theme="light"] .table-card.occupied  { background:#fff7ed; border-color:#fdba74; }
    [data-theme="light"] .table-card.reserved  { background:#eff6ff; border-color:#93c5fd; }

    .table-card.occupied::after { content:''; position:absolute; top:12px; right:12px; width:8px; height:8px; border-radius:50%; background:#fb923c; animation:pulse 2s infinite; }
    @@keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(251,146,60,.6)} 70%{box-shadow:0 0 0 7px rgba(251,146,60,0)} 100%{box-shadow:0 0 0 0 rgba(251,146,60,0)} }

    .table-card.reserved.warning-soon { animation:warningPulse 1.5s infinite; }
    @@keyframes warningPulse { 0%,100%{box-shadow:0 0 0 0 rgba(234,179,8,.5)} 50%{box-shadow:0 0 12px 4px rgba(234,179,8,.3)} }

    .card-name     { font-family:'Syne',sans-serif; font-size:18px; font-weight:800; }
    .card-status   { font-size:10px; font-weight:700; letter-spacing:.06em; text-transform:uppercase; }
    .available .card-status { color:#4ade80; }
    .occupied  .card-status { color:#fb923c; }
    .reserved  .card-status { color:#60a5fa; }
    .card-capacity { font-size:11px; color:var(--text-muted); }
    .card-divider  { height:1px; background:var(--border); }

    /* ✅ #5: Sipariş kalemleri kartı içinde */
    .order-items-preview {
        background: rgba(251,146,60,.06);
        border: 1px solid rgba(251,146,60,.2);
        border-radius: 9px;
        padding: 8px 10px;
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    .order-items-line {
        font-size: 11px;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .order-items-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .order-items-qty  { font-family:'Syne',sans-serif; font-size:11px; font-weight:700; color:#fb923c; margin-left:6px; white-space:nowrap; }
    .order-items-more {
        font-size: 11px;
        color: var(--accent);
        cursor: pointer;
        text-align: center;
        padding: 2px 0;
        border-top: 1px solid rgba(251,146,60,.15);
        margin-top: 2px;
        font-weight: 600;
    }
    .order-items-more:hover { text-decoration: underline; }
    .order-items-hidden { display: none; }

    /* Rezervasyon özet */
    .res-summary { background:rgba(96,165,250,.08); border:1px solid rgba(96,165,250,.2); border-radius:9px; padding:8px 10px; display:flex; flex-direction:column; gap:3px; cursor:pointer; transition:background .15s; }
    .res-summary:hover { background:rgba(96,165,250,.14); }
    .res-summary-name { font-size:13px; font-weight:700; color:#60a5fa; }
    .res-summary-time { font-size:11px; color:var(--text-muted); display:flex; align-items:center; gap:4px; }
    .res-warning-badge { font-size:10px; font-weight:700; background:rgba(234,179,8,.15); color:#eab308; padding:2px 6px; border-radius:20px; margin-left:auto; }

    .card-actions { display:flex; flex-direction:column; gap:6px; }
    .card-btn { padding:7px 0; border-radius:8px; font-size:12px; font-weight:700; text-align:center; border:1px solid; cursor:pointer; background:none; width:100%; transition:background .15s; display:block; font-family:'DM Sans',sans-serif; }
    .available .card-btn.primary   { border-color:#166534; color:#4ade80; }
    .available .card-btn.primary:hover { background:rgba(74,222,128,.1); }
    .available .card-btn.secondary { border-color:#1d4ed8; color:#60a5fa; }
    .available .card-btn.secondary:hover { background:rgba(96,165,250,.1); }
    .occupied  .card-btn.primary   { border-color:#c2410c; color:#fb923c; }
    .occupied  .card-btn.primary:hover  { background:rgba(251,146,60,.1); }
    .occupied  .card-btn.merge     { border-color:#7c3aed; color:#a78bfa; }
    .occupied  .card-btn.merge:hover    { background:rgba(167,139,250,.1); }
    .reserved  .card-btn.primary   { border-color:#1d4ed8; color:#60a5fa; }
    .reserved  .card-btn.primary:hover  { background:rgba(96,165,250,.1); }
    .reserved  .card-btn.secondary { border-color:#166534; color:#4ade80; }
    .reserved  .card-btn.secondary:hover { background:rgba(74,222,128,.1); }
    .card-btn.danger { border-color:#7f1d1d !important; color:#f87171 !important; }
    .card-btn.danger:hover { background:rgba(239,68,68,.1) !important; }

    /* Alert */
    .alert { padding:12px 16px; border-radius:10px; font-size:13px; border:1px solid; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
    .alert-success { background:rgba(34,197,94,.1); border-color:rgba(34,197,94,.3); color:#22c55e; }
    .alert-error   { background:rgba(239,68,68,.1); border-color:rgba(239,68,68,.3); color:#ef4444; }

    /* Toast */
    .toast-container { position:fixed; top:70px; right:20px; z-index:500; display:flex; flex-direction:column; gap:10px; }
    .toast { background:var(--surface); border:1px solid; border-radius:12px; padding:14px 18px; min-width:280px; max-width:340px; box-shadow:0 8px 28px rgba(0,0,0,.35); display:flex; align-items:flex-start; gap:10px; animation:toastIn .3s ease; }
    @@keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
    .toast.warning { border-color:rgba(234,179,8,.4); }
    .toast.danger  { border-color:rgba(239,68,68,.4); }
    .toast.info    { border-color:rgba(59,130,246,.4); }
    .toast-icon  { font-size:22px; flex-shrink:0; }
    .toast-body  { flex:1; }
    .toast-title { font-family:'Syne',sans-serif; font-size:13px; font-weight:700; }
    .toast-title.warning { color:#eab308; }
    .toast-title.danger  { color:#ef4444; }
    .toast-title.info    { color:#60a5fa; }
    .toast-msg   { font-size:12px; color:var(--text-muted); margin-top:3px; line-height:1.4; }
    .toast-close { background:none; border:none; color:var(--text-muted); font-size:18px; cursor:pointer; flex-shrink:0; line-height:1; }

    /* Modal */
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); z-index:200; align-items:center; justify-content:center; }
    .modal-overlay.open { display:flex; }
    .modal { background:var(--surface); border:1px solid var(--border); border-radius:18px; padding:26px; width:420px; max-width:95vw; box-shadow:0 20px 60px rgba(0,0,0,.5); animation:modalIn .2s ease; }
    @@keyframes modalIn { from{opacity:0;transform:scale(.93) translateY(8px)} to{opacity:1;transform:scale(1) translateY(0)} }
    .modal-title { font-family:'Syne',sans-serif; font-size:18px; font-weight:700; margin-bottom:6px; }
    .modal-sub   { font-size:13px; color:var(--text-muted); margin-bottom:20px; }
    .form-row    { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .form-group  { display:flex; flex-direction:column; gap:4px; margin-bottom:12px; }
    .form-label  { font-size:11px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.05em; }
    .form-control { background:var(--surface2); border:1px solid var(--border); border-radius:9px; padding:10px 13px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; outline:none; width:100%; transition:border-color .15s; }
    .form-control:focus { border-color:var(--accent); }
    .form-error  { font-size:11px; color:#ef4444; margin-top:3px; display:none; }
    .modal-footer { display:flex; gap:10px; margin-top:18px; }
    .btn-primary { flex:1; padding:10px; background:var(--accent); color:#fff; border:none; border-radius:9px; font-size:14px; font-weight:700; cursor:pointer; transition:background .15s; font-family:'DM Sans',sans-serif; }
    .btn-primary:hover { background:#ea6c0a; }
    .btn-ghost   { flex:1; padding:10px; background:var(--surface2); color:var(--text-muted); border:1px solid var(--border); border-radius:9px; font-size:14px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; }
    .btn-ghost:hover { color:var(--text); }

    /* ✅ #4: Birleştirme modalı */
    .merge-arrow { text-align:center; font-size:24px; padding:8px 0; color:var(--accent); }
    .merge-table-select { display:grid; gap:8px; max-height:260px; overflow-y:auto; }
    .merge-option { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:10px; border:1.5px solid var(--border); background:var(--surface2); cursor:pointer; transition:all .15s; }
    .merge-option:hover { border-color:var(--accent); background:var(--accent-glow); }
    .merge-option.selected { border-color:#7c3aed; background:rgba(124,58,237,.1); }
    .merge-option-name  { font-size:14px; font-weight:700; flex:1; }
    .merge-option-info  { font-size:11px; color:var(--text-muted); }
    .merge-option-total { font-family:'Syne',sans-serif; font-size:13px; font-weight:700; color:var(--accent); }

    .res-detail-row { display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid var(--border); }
    .res-detail-row:last-child { border-bottom:none; }
    .res-detail-icon  { font-size:18px; width:24px; text-align:center; flex-shrink:0; }
    .res-detail-label { font-size:11px; color:var(--text-muted); font-weight:600; }
    .res-detail-value { font-size:14px; font-weight:600; margin-top:1px; }

    .empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
    .empty-state .empty-icon { font-size:48px; margin-bottom:12px; }

    @@media(max-width:480px) { .tables-grid{grid-template-columns:repeat(2,1fr)} .form-row{grid-template-columns:1fr} }
</style>
}

<div class="toast-container" id="toastContainer"></div>

@if (TempData["Success"] != null) { <div class="alert alert-success">✅ @TempData["Success"]</div> }
@if (TempData["Error"]   != null) { <div class="alert alert-error">❌ @TempData["Error"]</div> }

<div class="page-header">
    <div>
        <h1 class="page-title">Masa Yönetimi</h1>
        <p class="page-sub">Masaya tıklayarak adisyon aç veya rezerve et</p>
    </div>
    <div class="toolbar">
        <div class="filter-btns">
            <button class="filter-btn active" data-filter="all">Tümü</button>
            <button class="filter-btn" data-filter="available">Boş</button>
            <button class="filter-btn" data-filter="occupied">Dolu</button>
            <button class="filter-btn" data-filter="reserved">Rezerve</button>
        </div>
        <button class="btn-add" onclick="openModal('addModal')">＋ Masa Ekle</button>
    </div>
</div>

<div class="summary-bar">
    <div class="summary-chip"><div class="chip-icon">🪑</div><div><div class="chip-val">@Model.Count()</div><div class="chip-lbl">Toplam Masa</div></div></div>
    <div class="summary-chip"><div class="chip-icon">🔴</div><div><div class="chip-val" style="color:#fb923c">@Model.Count(t => t.TableStatus == 1)</div><div class="chip-lbl">Dolu</div></div></div>
    <div class="summary-chip"><div class="chip-icon">🟢</div><div><div class="chip-val" style="color:#4ade80">@Model.Count(t => t.TableStatus == 0)</div><div class="chip-lbl">Boş</div></div></div>
    <div class="summary-chip"><div class="chip-icon">🔵</div><div><div class="chip-val" style="color:#60a5fa">@Model.Count(t => t.TableStatus == 2)</div><div class="chip-lbl">Rezerve</div></div></div>
</div>

@if (!Model.Any())
{
    <div class="empty-state"><div class="empty-icon">🪑</div><p>Henüz masa eklenmemiş.</p></div>
}
else
{
    <div class="tables-grid" id="tablesGrid">
        @foreach (var table in Model)
        {
            var sc           = StatusClass(table.TableStatus);
            var localResTime = table.ReservationTime?.ToLocalTime();
            var warningSoon  = table.TableStatus == 2
                && localResTime.HasValue
                && localResTime.Value <= DateTime.Now.AddMinutes(30)
                && localResTime.Value >= DateTime.Now;

            @* ✅ #5: Dolu masadaki sipariş kalemleri — birleştirilmiş (aynı ürün toplanmış) *@
            var openOrder    = table.Orders?.FirstOrDefault(o => o.OrderStatus == "open");
            var mergedItems  = openOrder?.OrderItems
                .Where(i => i.OrderItemStatus != "cancelled")
                .GroupBy(i => i.MenuItemId)
                .Select(g => new {
                    Name = g.First().MenuItem?.MenuItemName ?? "?",
                    Qty  = g.Sum(x => x.OrderItemQuantity)
                })
                .OrderBy(x => x.Name)
                .ToList();
            var itemCount    = mergedItems?.Count ?? 0;
            var showLimit    = 5;

            <div class="table-card @sc @(warningSoon ? "warning-soon" : "")"
                 data-status="@sc"
                 data-table-id="@table.TableId"
                 data-table-name="@table.TableName">

                <div class="card-name">@table.TableName</div>
                <div class="card-status">@StatusDot(table.TableStatus) @StatusLabel(table.TableStatus)</div>
                <div class="card-capacity">👥 @table.TableCapacity kişilik</div>
                <div class="card-divider"></div>

                @* ✅ #5: Kart içi sipariş kalemleri (sadece dolu masada) *@
                @if (table.TableStatus == 1 && mergedItems != null && mergedItems.Any())
                {
                    <div class="order-items-preview" id="items-@table.TableId">
                        @for (int i = 0; i < mergedItems.Count; i++)
                        {
                            var mi = mergedItems[i];
                            <div class="order-items-line @(i >= showLimit ? "order-items-hidden" : "")"
                                 data-item-index="@i">
                                <span class="order-items-name">@mi.Name</span>
                                <span class="order-items-qty">×@mi.Qty</span>
                            </div>
                        }
                        @if (itemCount > showLimit)
                        {
                            <div class="order-items-more" id="more-@table.TableId"
                                 onclick="toggleItems('@table.TableId', @itemCount, @showLimit)">
                                +@(itemCount - showLimit) kalem daha...
                            </div>
                        }
                    </div>
                }

                @* Rezervasyon özet *@
                @if (table.TableStatus == 2 && table.ReservationName != null)
                {
                    <div class="res-summary" onclick="showResDetail('@table.TableId')">
                        <div class="res-summary-name">👤 @table.ReservationName</div>
                        <div class="res-summary-time">
                            🕐 @localResTime?.ToString("HH:mm") — @table.ReservationGuestCount kişi
                            @if (warningSoon) { <span class="res-warning-badge">⚠ Yaklaşıyor</span> }
                        </div>
                    </div>
                }

                <div class="card-actions">
                    @if (table.TableStatus == 0)
                    {
                        <a asp-controller="Orders" asp-action="Create"
                           asp-route-tableId="@table.TableId"
                           class="card-btn primary">Adisyon Aç</a>
                        <button class="card-btn secondary"
                                onclick="openReserveModal(@table.TableId, '@table.TableName', @table.TableCapacity)">
                            Rezerve Et
                        </button>
                    }
                    else if (table.TableStatus == 1)
                    {
                        <a asp-controller="Orders" asp-action="Create"
                           asp-route-tableId="@table.TableId"
                           class="card-btn primary">Adisyona Git →</a>
                        @* ✅ #4: Birleştirme butonu — sadece dolu masalarda *@
                        <button class="card-btn merge"
                                onclick="openMergeModal(@table.TableId, '@table.TableName')">
                            ⇄ Masayı Birleştir
                        </button>
                    }
                    else if (table.TableStatus == 2)
                    {
                        <a asp-controller="Orders" asp-action="Create"
                           asp-route-tableId="@table.TableId"
                           class="card-btn primary">Adisyon Aç</a>
                        <form asp-controller="Tables" asp-action="CancelReserve" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="tableId" value="@table.TableId" />
                            <button type="submit" class="card-btn secondary">Rezervasyonu İptal Et</button>
                        </form>
                    }

                    @if (table.TableStatus != 1)
                    {
                        <form asp-controller="Tables" asp-action="Delete" method="post"
                              onsubmit="return confirm('@table.TableName silinsin mi?')">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="tableId" value="@table.TableId" />
                            <button type="submit" class="card-btn danger">Sil</button>
                        </form>
                    }
                </div>
            </div>
        }
    </div>
}

@* ── MASA EKLE MODAL ── *@
<div class="modal-overlay" id="addModal">
    <div class="modal">
        <div class="modal-title">Yeni Masa Ekle</div>
        <form asp-controller="Tables" asp-action="Create" method="post" onsubmit="return validateForm()">
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label class="form-label">Masa Adı *</label>
                <input class="form-control" id="add-name" name="tableName" placeholder="Masa 1, Teras-2 ..." maxlength="20" />
                <span class="form-error" id="err-add-name">Masa adı boş olamaz.</span>
            </div>
            <div class="form-group">
                <label class="form-label">Kapasite *</label>
                <input class="form-control" id="add-cap" name="tableCapacity" type="number" min="1" max="20" value="4" />
                <span class="form-error" id="err-add-cap">1 ile 20 arasında olmalıdır.</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost" onclick="closeModal('addModal')">İptal</button>
                <button type="submit" class="btn-primary">Ekle</button>
            </div>
        </form>
    </div>
</div>

@* ── REZERVE ET MODAL ── *@
<div class="modal-overlay" id="reserveModal">
    <div class="modal">
        <div class="modal-title" id="res-modal-title">Rezervasyon</div>
        <div class="modal-sub"  id="res-modal-sub">Müşteri bilgilerini giriniz</div>
        <form asp-controller="Tables" asp-action="Reserve" method="post" onsubmit="return validateReserveForm()">
            @Html.AntiForgeryToken()
            <input type="hidden" id="res-tableId" name="tableId" />
            <input type="hidden" id="res-maxCap"  value="" />
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">İsim Soyisim *</label>
                    <input class="form-control" id="res-name" name="reservationName" placeholder="Ahmet Yılmaz" maxlength="100" />
                    <span class="form-error" id="err-res-name">Ad soyad boş olamaz.</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefon *</label>
                    <input class="form-control" id="res-phone" name="reservationPhone" placeholder="05xx xxx xx xx" maxlength="20" />
                    <span class="form-error" id="err-res-phone">Telefon numarası boş olamaz.</span>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Kişi Sayısı *</label>
                    <input class="form-control" id="res-guests" name="reservationGuestCount" type="number" min="1" value="2" />
                    <span class="form-error" id="err-res-guests">Geçerli bir kişi sayısı girin.</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Rezervasyon Saati *</label>
                    <input class="form-control" id="res-time" name="reservationTime" type="time" />
                    <span class="form-error" id="err-res-time">Geçerli bir saat seçiniz.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost" onclick="closeModal('reserveModal')">İptal</button>
                <button type="submit" class="btn-primary">Rezerve Et</button>
            </div>
        </form>
    </div>
</div>

@* ── ✅ #4: MASA BİRLEŞTİRME MODAL ── *@
<div class="modal-overlay" id="mergeModal">
    <div class="modal">
        <div class="modal-title">⇄ Masa Birleştir</div>
        <div class="modal-sub" id="merge-sub">Hangi masayla birleştirmek istiyorsunuz?</div>

        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border)">
            <span style="font-size:18px">🪑</span>
            <div>
                <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:600;">Kaynak Masa</div>
                <div style="font-size:15px;font-weight:700" id="merge-source-name">—</div>
            </div>
        </div>

        <div class="merge-arrow">↓ birleştirilecek</div>

        <div class="form-group" style="margin-top:12px">
            <label class="form-label">Hedef Masayı Seçin *</label>
            <div class="merge-table-select" id="mergeTargetList">
                @* JS ile doldurulacak *@
            </div>
        </div>

        <form id="mergeForm" asp-controller="Tables" asp-action="MergeOrder" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="sourceTableId" id="merge-sourceTableId" />
            <input type="hidden" name="targetTableId" id="merge-targetTableId" />
            <div class="modal-footer">
                <button type="button" class="btn-ghost" onclick="closeModal('mergeModal')">İptal</button>
                <button type="submit" class="btn-primary" id="merge-submit-btn" disabled
                        onclick="return confirmMerge()">
                    ⇄ Birleştir
                </button>
            </div>
        </form>
    </div>
</div>

@* ── REZERVASYON DETAY MODAL ── *@
<div class="modal-overlay" id="resDetailModal">
    <div class="modal" style="width:360px">
        <div class="modal-title">Rezervasyon Detayı</div>
        <div id="resDetailContent" style="margin:16px 0"></div>
        <div class="modal-footer">
            <button class="btn-ghost" onclick="closeModal('resDetailModal')">Kapat</button>
        </div>
    </div>
</div>

@* Rezervasyon verisi *@
<script id="reservationData" type="application/json">
@Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    Model.Where(t => t.TableStatus == 2 && t.ReservationTime.HasValue)
         .Select(t => new {
             id        = t.TableId,
             name      = t.TableName,
             resName   = t.ReservationName,
             resPhone  = t.ReservationPhone,
             resGuests = t.ReservationGuestCount,
             resTime    = t.ReservationTime!.Value.ToLocalTime().ToString("HH:mm"),
             resTimeIso = t.ReservationTime!.Value.ToLocalTime().ToString("yyyy-MM-ddTHH:mm:ss")
         })
))
</script>

@* ✅ #4: Tüm masaları JS'e ver (birleştirme hedef listesi için) *@
<script id="allTablesData" type="application/json">
@Html.Raw(System.Text.Json.JsonSerializer.Serialize(
    Model.Select(t => new {
        id     = t.TableId,
        name   = t.TableName,
        status = t.TableStatus,
        total  = t.Orders?.FirstOrDefault(o => o.OrderStatus == "open")?.OrderTotalAmount ?? 0,
        itemCount = t.Orders?.FirstOrDefault(o => o.OrderStatus == "open")
                    ?.OrderItems.Count(i => i.OrderItemStatus != "cancelled") ?? 0
    })
))
</script>

@section Scripts {
<script>
    const reservations = JSON.parse(document.getElementById('reservationData').textContent);
    const allTables    = JSON.parse(document.getElementById('allTablesData').textContent);

    // ── Modal ──────────────────────────────────────────────────────
    function openModal(id)  { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    document.querySelectorAll('.modal-overlay').forEach(o =>
        o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); })
    );

    // ── Rezerve modal ──────────────────────────────────────────────
    function openReserveModal(tableId, tableName, maxCap) {
        document.getElementById('res-tableId').value           = tableId;
        document.getElementById('res-maxCap').value            = maxCap;
        document.getElementById('res-modal-title').textContent = tableName + ' — Rezervasyon';
        document.getElementById('res-guests').max = maxCap;
        const d = new Date(); d.setHours(d.getHours() + 1, 0, 0);
        document.getElementById('res-time').value =
            String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
        ['res-name','res-phone','res-guests','res-time'].forEach(id => {
            document.getElementById('err-' + id).style.display = 'none';
            document.getElementById(id).style.borderColor = '';
        });
        openModal('reserveModal');
    }

    // ── ✅ #4: Birleştirme modal ───────────────────────────────────
    let mergeSourceId = null;
    let mergeTargetId = null;

    function openMergeModal(sourceTableId, sourceTableName) {
        mergeSourceId = sourceTableId;
        mergeTargetId = null;
        document.getElementById('merge-sourceTableId').value = sourceTableId;
        document.getElementById('merge-targetTableId').value = '';
        document.getElementById('merge-source-name').textContent = sourceTableName;
        document.getElementById('merge-sub').textContent =
            `${sourceTableName} adisyonunu hangi masayla birleştirmek istersiniz?`;
        document.getElementById('merge-submit-btn').disabled = true;

        // Hedef listesini doldur — kaynak hariç tüm masalar
        const list = document.getElementById('mergeTargetList');
        list.innerHTML = '';

        const targets = allTables.filter(t => t.id !== sourceTableId);
        if (targets.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px">Başka masa bulunamadı.</div>';
        } else {
            targets.forEach(t => {
                const div = document.createElement('div');
                div.className = 'merge-option';
                div.dataset.targetId = t.id;
                const statusLabel = t.status === 1 ? '🔴 Dolu' : t.status === 2 ? '🔵 Rezerve' : '🟢 Boş';
                const infoText = t.status === 1
                    ? `${t.itemCount} kalem · ₺${t.total.toFixed(2).replace('.',',')} — adisyonlar birleşecek`
                    : 'Adisyon bu masaya taşınacak';
                div.innerHTML = `
                    <div style="font-size:20px">🪑</div>
                    <div style="flex:1">
                        <div class="merge-option-name">${t.name}</div>
                        <div class="merge-option-info">${statusLabel} · ${infoText}</div>
                    </div>
                    ${t.status === 1 ? `<div class="merge-option-total">₺${t.total.toFixed(2).replace('.',',')}</div>` : ''}
                `;
                div.addEventListener('click', () => selectMergeTarget(t.id, div));
                list.appendChild(div);
            });
        }

        openModal('mergeModal');
    }

    function selectMergeTarget(targetId, el) {
        document.querySelectorAll('.merge-option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        mergeTargetId = targetId;
        document.getElementById('merge-targetTableId').value = targetId;
        document.getElementById('merge-submit-btn').disabled = false;
    }

    function confirmMerge() {
        if (!mergeTargetId) return false;
        const src = allTables.find(t => t.id === mergeSourceId);
        const tgt = allTables.find(t => t.id === mergeTargetId);
        const msg = tgt.status === 1
            ? `${src.name} ve ${tgt.name} adisyonları birleştirilecek. Onaylıyor musunuz?`
            : `${src.name} adisyonu ${tgt.name} masasına taşınacak. Onaylıyor musunuz?`;
        return confirm(msg);
    }

    // ── ✅ #5: Kalemleri genişlet / daralt ────────────────────────
    function toggleItems(tableId, total, limit) {
        const container = document.getElementById('items-' + tableId);
        const btn       = document.getElementById('more-' + tableId);
        const hidden    = container.querySelectorAll('.order-items-hidden');
        const expanded  = btn.dataset.expanded === 'true';

        if (expanded) {
            // Daralt
            hidden.forEach(el => el.style.display = 'none');
            btn.textContent    = `+${total - limit} kalem daha...`;
            btn.dataset.expanded = 'false';
        } else {
            // Genişlet
            container.querySelectorAll('[data-item-index]').forEach(el => {
                el.style.display = 'flex';
            });
            btn.textContent    = '▲ Daralt';
            btn.dataset.expanded = 'true';
        }
    }

    // Sayfa yüklendiğinde hidden'ları gizle
    document.querySelectorAll('.order-items-hidden').forEach(el => {
        el.style.display = 'none';
    });

    // ── Rezervasyon detay ──────────────────────────────────────────
    function showResDetail(tableId) {
        const r = reservations.find(x => x.id == tableId);
        if (!r) return;
        document.getElementById('resDetailContent').innerHTML = `
            <div class="res-detail-row"><div class="res-detail-icon">👤</div><div><div class="res-detail-label">İsim Soyisim</div><div class="res-detail-value">${r.resName}</div></div></div>
            <div class="res-detail-row"><div class="res-detail-icon">📞</div><div><div class="res-detail-label">Telefon</div><div class="res-detail-value">${r.resPhone}</div></div></div>
            <div class="res-detail-row"><div class="res-detail-icon">👥</div><div><div class="res-detail-label">Kişi Sayısı</div><div class="res-detail-value">${r.resGuests} kişi</div></div></div>
            <div class="res-detail-row"><div class="res-detail-icon">🕐</div><div><div class="res-detail-label">Rezervasyon Saati</div><div class="res-detail-value">${r.resTime}</div></div></div>
        `;
        openModal('resDetailModal');
    }

    // ── Validasyon ─────────────────────────────────────────────────
    function validateForm() {
        let ok = true;
        const name = document.getElementById('add-name');
        const cap  = document.getElementById('add-cap');
        const errN = document.getElementById('err-add-name');
        const errC = document.getElementById('err-add-cap');
        if (!name.value.trim()) { errN.style.display='block'; name.style.borderColor='#ef4444'; ok=false; }
        else { errN.style.display='none'; name.style.borderColor=''; }
        const v = parseInt(cap.value);
        if (isNaN(v)||v<1||v>20) { errC.style.display='block'; cap.style.borderColor='#ef4444'; ok=false; }
        else { errC.style.display='none'; cap.style.borderColor=''; }
        return ok;
    }

    function validateReserveForm() {
        let ok = true;
        const maxCap = parseInt(document.getElementById('res-maxCap').value);
        const fields = [
            { id:'res-name',   err:'err-res-name',   check: v => v.trim().length > 0,  msg:'Ad soyad boş olamaz.' },
            { id:'res-phone',  err:'err-res-phone',  check: v => v.trim().length >= 10, msg:'Geçerli telefon giriniz.' },
            { id:'res-guests', err:'err-res-guests', check: v => v >= 1 && v <= maxCap, msg:`1 ile ${maxCap} arasında olmalı.` },
            { id:'res-time',   err:'err-res-time',   check: v => v.length > 0,          msg:'Saat seçiniz.' },
        ];
        fields.forEach(f => {
            const el  = document.getElementById(f.id);
            const err = document.getElementById(f.err);
            const val = f.id === 'res-guests' ? parseInt(el.value) : el.value;
            if (!f.check(val)) { err.textContent=f.msg; err.style.display='block'; el.style.borderColor='#ef4444'; ok=false; }
            else { err.style.display='none'; el.style.borderColor=''; }
        });
        return ok;
    }

    // ── Filtre ─────────────────────────────────────────────────────
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const f = btn.dataset.filter;
            document.querySelectorAll('.table-card').forEach(c => {
                c.style.display = f === 'all' || c.dataset.status === f ? '' : 'none';
            });
        });
    });

    // ── Alert otomatik kaybol ──────────────────────────────────────
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(a => {
            a.style.transition = 'opacity .5s'; a.style.opacity = '0';
            setTimeout(() => a.remove(), 500);
        });
    }, 3000);

    // ── Toast ──────────────────────────────────────────────────────
    function showToast(id, type, icon, title, msg, autocloseMs) {
        if (document.getElementById(id)) return;
        const toast = document.createElement('div');
        toast.id = id; toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-body">
                <div class="toast-title ${type}">${title}</div>
                <div class="toast-msg">${msg}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">×</button>`;
        document.getElementById('toastContainer').appendChild(toast);
        if (autocloseMs) setTimeout(() => toast.remove(), autocloseMs);
    }

    // ── Rezervasyon uyarı sistemi ──────────────────────────────────
    function checkReservationWarnings() {
        const now = new Date();
        reservations.forEach(r => {
            const resTime = new Date(r.resTimeIso);
            const diffMin = Math.floor((resTime - now) / 60000);

            if (diffMin >= 0 && diffMin <= 30) {
                document.getElementById('toast-late-' + r.id)?.remove();
                showToast('toast-' + r.id, 'warning', '⚠️',
                    `${r.name} — Rezervasyon Yaklaşıyor`,
                    `<strong>${r.resName}</strong> (${r.resGuests} kişi) saat <strong>${r.resTime}</strong>'de bekleniyor. Kalan: ~${diffMin} dakika`,
                    null);
            }
            if (diffMin < 0 && diffMin >= -30) {
                document.getElementById('toast-' + r.id)?.remove();
                showToast('toast-late-' + r.id, 'danger', '🚨',
                    `${r.name} — Misafir Gelmedi Mi?`,
                    `<strong>${r.resName}</strong>, saatinden <strong>${Math.abs(diffMin)} dk</strong> geçti. ${30 + diffMin} dk sonra oto-temizlenecek.`,
                    null);
            }
            if (diffMin < -30) {
                document.getElementById('toast-' + r.id)?.remove();
                document.getElementById('toast-late-' + r.id)?.remove();
                if (!window._reloadScheduled) {
                    window._reloadScheduled = true;
                    showToast('toast-reload', 'info', 'ℹ️', 'Masa Durumu Güncellendi',
                        'Süresi dolan rezervasyon temizlendi. Sayfa yenileniyor...', 3500);
                    setTimeout(() => location.reload(), 4000);
                }
            }
        });
    }

    checkReservationWarnings();
    setInterval(checkReservationWarnings, 60000);
</script>
}
